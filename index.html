<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°nkÄ±lap Tarihi AkÄ±llÄ± Ã‡alÄ±ÅŸma KaÄŸÄ±dÄ± AsistanÄ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        h1 { color: #0056b3; text-align: center; }
        select, button { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; margin-top: 5px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
        .kaynak-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; border: 1px solid transparent; }
        .kaynak-item:hover { background-color: #f0f0f0; }
        .kaynak-item.selected { border-color: #007bff; background-color: #e7f3ff; }
        .kaynak-item .icon { font-size: 24px; margin-right: 10px; }
        .kaynak-gorsel { max-width: 100%; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ä°nkÄ±lap Tarihi AkÄ±llÄ± Ã‡alÄ±ÅŸma KaÄŸÄ±dÄ± AsistanÄ±</h1>
        <div class="form-group"><label for="unite-secimi">Ãœnite SeÃ§imi:</label><select id="unite-secimi"><option value="">LÃ¼tfen bir Ã¼nite seÃ§iniz</option></select></div>
        <div class="form-group"><label for="kazanim-secimi">KazanÄ±m SeÃ§imi:</label><select id="kazanim-secimi" disabled><option value="">LÃ¼tfen Ã¶nce Ã¼nite seÃ§iniz</option></select></div>
        
        <div class="form-group">
            <label for="kaynak-listesi">Kaynak SeÃ§imi:</label>
            <div id="kaynak-listesi" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 50px;">
                <p style="color: #6c757d;">LÃ¼tfen Ã¶nce kazanÄ±m seÃ§iniz</p>
            </div>
        </div>

        <button id="olustur-butonu" disabled>Ã‡alÄ±ÅŸma KaÄŸÄ±dÄ± OluÅŸtur</button>
        <button id="indir-pdf-butonu" style="display: none; margin-top: 10px; background-color: #28a745;">PDF Olarak Ä°ndir</button>

        <div id="kaynak-basligi" style="margin-top: 20px; display: none;"><h3>KullanÄ±lan Birinci Elden Kaynak:</h3></div>
        <div id="kaynak-alani"></div>
        <div id="sonuc-basligi" style="margin-top: 20px; display: none;"><h3>OluÅŸturulan Ã‡alÄ±ÅŸma KaÄŸÄ±dÄ±:</h3></div>
        <div id="sonuc-alani"></div>
    </div>

<script>
    const API_ENDPOINT_URL = 'https://duwr3ymxi6.execute-api.eu-central-1.amazonaws.com/';

    let sonApiCevabi = null;

    const uniteSecimi = document.getElementById('unite-secimi');
    const kazanimSecimi = document.getElementById('kazanim-secimi');
    const kaynakListesi = document.getElementById('kaynak-listesi');
    const olusturButonu = document.getElementById('olustur-butonu');
    const kaynakBasligi = document.getElementById('kaynak-basligi');
    const kaynakAlani = document.getElementById('kaynak-alani');
    const sonucBasligi = document.getElementById('sonuc-basligi');
    const sonucAlani = document.getElementById('sonuc-alani');
    const indirPdfButonu = document.getElementById('indir-pdf-butonu');

    const mockUniteler = [
        { id: "1", ad: "1. 20. YÃ¼zyÄ±l BaÅŸlarÄ±nda OsmanlÄ± Devleti ve DÃ¼nya" },
        { id: "2", ad: "2. Milli MÃ¼cadele" },
        { id: "3", ad: "3. AtatÃ¼rkÃ§Ã¼lÃ¼k ve TÃ¼rk Ä°nkÄ±labÄ±" },
        { id: "4", ad: "4. Ä°ki SavaÅŸ ArasÄ±ndaki DÃ¶nemde TÃ¼rkiye ve DÃ¼nya" },
        { id: "5", ad: "5. II.DÃ¼nya SavaÅŸÄ± SÃ¼recinde TÃ¼rkiye ve DÃ¼nya" },
        { id: "6", ad: "6. II.DÃ¼nya SavaÅŸÄ± SonrasÄ±nda TÃ¼rkiye ve DÃ¼nya" },
        { id: "7", ad: "7. Toplumsal Devrim Ã‡aÄŸÄ±nda DÃ¼nya ve TÃ¼rkiye" },
        { id: "8", ad: "8. 21. YÃ¼zyÄ±lÄ±n EÅŸiÄŸinde TÃ¼rkiye ve DÃ¼nya" }
    ];

    const mockKazanimlar = {
        "1": [
            { id: "1.1", ad: "1.1. Mustafa Kemalâ€™in Birinci DÃ¼nya SavaÅŸÄ±â€™na kadarki eÄŸitim ve askerlik hayatÄ±nÄ± iÃ§inde bulunduÄŸu toplumun siyasi, sosyal ve kÃ¼ltÃ¼rel yapÄ±sÄ± ile iliÅŸkilendirir" },
            { id: "1.2", ad: "1.2. 20. yÃ¼zyÄ±l baÅŸlarÄ±nda OsmanlÄ± Devletiâ€™nin siyasi, sosyal ve ekonomik durumunu analiz eder." },
            { id: "1.3", ad: "1.3. I. DÃ¼nya SavaÅŸÄ± sÃ¼recinde OsmanlÄ± Devletiâ€™nin durumunu siyasi, askerÃ® ve sosyal aÃ§Ä±lardan analiz eder." },
            { id: "1.4", ad: "1.4. I. DÃ¼nya SavaÅŸÄ±â€™nÄ±n sonuÃ§larÄ±nÄ± OsmanlÄ± Devleti ve BatÄ±lÄ± devletler aÃ§Ä±sÄ±ndan deÄŸerlendirir." }
        ],
        "2": [
            { id: "2.1", ad: "2.1. Kuvay-Ä± MillÃ®ye hareketinin oluÅŸumundan BÃ¼yÃ¼k Millet Meclisinin aÃ§Ä±lÄ±ÅŸÄ±na kadar olan sÃ¼reÃ§te meydana gelen geliÅŸmeleri aÃ§Ä±klar." },
            { id: "2.2", ad: "2.2. BÃ¼yÃ¼k Millet Meclisinin aÃ§Ä±lÄ±ÅŸ sÃ¼recini ve sonrasÄ±nda meydana gelen geliÅŸmeleri kavrar." },
            { id: "2.3", ad: "2.3. Sevr AntlaÅŸmasÄ±â€™nÄ±n MillÃ® MÃ¼cadele sÃ¼recine etkilerini analiz eder." },
            { id: "2.4", ad: "2.4. DoÄŸu ve GÃ¼ney Cephelerinde verilen mÃ¼cadelelerin Ã¼lkemizin baÄŸÄ±msÄ±zlÄ±k sÃ¼recine katkÄ±larÄ±nÄ± kavrar." },
            { id: "2.5", ad: "2.5. DÃ¼zenli ordunun kurulmasÄ±ndan Mudanya AteÅŸkes AntlaÅŸmasÄ±â€™na kadar meydana gelen geliÅŸmeleri TÃ¼rkiyeâ€™nin baÄŸÄ±msÄ±zlÄ±k sÃ¼recine katkÄ±larÄ± aÃ§Ä±sÄ±ndan analiz eder." },
            { id: "2.6", ad: "2.6. MillÃ® MÃ¼cadele sonucunda kazanÄ±lan diplomatik baÅŸarÄ±larÄ± Ã¼lkemizin baÄŸÄ±msÄ±zlÄ±ÄŸÄ± aÃ§Ä±sÄ±ndan deÄŸerlendirir.2.6. MillÃ® MÃ¼cadele sonucunda kazanÄ±lan diplomatik baÅŸarÄ±larÄ± Ã¼lkemizin baÄŸÄ±msÄ±zlÄ±ÄŸÄ± aÃ§Ä±sÄ±ndan deÄŸerlendirir." },
            { id: "2.7", ad: "2.7. MillÃ® MÃ¼cadele sÃ¼recine katkÄ±da bulunmuÅŸ Ã¶nemli ÅŸahsiyetlerin kiÅŸilik Ã¶zellikleri ile faaliyetlerini iliÅŸkilendirir." }
        ],
        "3": [
            { id: "3.1", ad: "3.1. Ã‡aÄŸdaÅŸlaÅŸan TÃ¼rkiyeâ€™nin temeli olan AtatÃ¼rk ilkelerini kavrar." },
            { id: "3.2", ad: "3.2. Siyasi alanda meydana gelen geliÅŸmeleri kavrar." },
            { id: "3.3", ad: "3.3. Hukuk alanÄ±nda meydana gelen geliÅŸmelerin TÃ¼rk toplumunda meydana getirdiÄŸi deÄŸiÅŸimleri kavrar." },
            { id: "3.4", ad: "3.4. EÄŸitim ve kÃ¼ltÃ¼r alanÄ±nda yapÄ±lan inkÄ±laplarÄ± ve geliÅŸmeleri kavrar." },
            { id: "3.5", ad: "3.5. Toplumsal alanda yapÄ±lan inkÄ±laplarÄ± ve meydana gelen geliÅŸmeleri kavrar." },
            { id: "3.6", ad: "3.6. Ekonomi alanÄ±nda meydana gelen geliÅŸmeleri kavrar." },
            { id: "3.7", ad: "3.7. AtatÃ¼rk DÃ¶nemiâ€™nde saÄŸlÄ±k alanÄ±nda yapÄ±lan Ã§alÄ±ÅŸmalarÄ± kavrar." },
            { id: "3.8", ad: "3.7. AtatÃ¼rk ilke ve inkÄ±laplarÄ±nÄ± oluÅŸturan temel esaslarÄ± AtatÃ¼rkÃ§Ã¼ dÃ¼ÅŸÃ¼nce sistemi aÃ§Ä±sÄ±ndan analiz eder." },
        ],
        "4": [
            { id: "4.1", ad: "4.1. AtatÃ¼rk DÃ¶nemiâ€™nde TÃ¼rkiye Cumhuriyetiâ€™nin iÃ§ politikasÄ±ndaki Ã¶nemli geliÅŸmeleri aÃ§Ä±klar." },
            { id: "4.2", ad: "4.2. AtatÃ¼rk DÃ¶nemiâ€™nde (1923-1938) TÃ¼rkiye Cumhuriyetiâ€™nin dÄ±ÅŸ politikasÄ±ndaki baÅŸlÄ±ca geliÅŸmeleri aÃ§Ä±klar. " },
            { id: "4.3", ad: "4.3. Ä°ki dÃ¼nya savaÅŸÄ± arasÄ±ndaki dÃ¶nemde dÃ¼nyada meydana gelen siyasi ve ekonomik geliÅŸmeleri kavrar." },
        ],
        "5": [
            { id: "5.1", ad: "5.1. II. DÃ¼nya SavaÅŸÄ±â€™nÄ±n sebepleri, baÅŸlamasÄ± ve yayÄ±lmasÄ±yla ilgili baÅŸlÄ±ca geliÅŸmeleri kavrar" },
            { id: "5.2", ad: "5.2. II. DÃ¼nya SavaÅŸÄ± sÃ¼recinde TÃ¼rkiyeâ€™nin izlediÄŸi siyaset ile savaÅŸÄ±n TÃ¼rkiye Ã¼zerindeki ekonomik ve toplumsal etkilerini analiz eder." },
            { id: "5.3", ad: "5.3. II. DÃ¼nya SavaÅŸÄ±â€™nÄ±n sonuÃ§larÄ±nÄ± deÄŸerlendirir." },
        ],
        "6": [
            { id: "6.1", ad: "6.1. 1945-1950 yÄ±llarÄ± arasÄ±nda TÃ¼rkiyeâ€™de meydana gelen siyasi, sosyal ve ekonomik geliÅŸmeleri kavrar." },
            { id: "6.2", ad: "6.2. II. DÃ¼nya SavaÅŸÄ± sonrasÄ± dÃ¶nemde uluslararasÄ± iliÅŸkilerde ve TÃ¼rk dÄ±ÅŸ politikasÄ±nda meydana gelen geliÅŸmeleri kavrar." },
            { id: "6.3", ad: "6.3. 1950â€™ler TÃ¼rkiyeâ€™sinde meydana gelen siyasi, sosyal ve ekonomik geliÅŸmeleri analiz eder." },
        ],
        "7": [
            { id: "7.1", ad: "7.1. 1960 sonrasÄ±nda dÃ¼nya siyasetinde ortaya Ã§Ä±kan geliÅŸmeleri aÃ§Ä±klar." },
            { id: "7.2", ad: "7.2. 1960â€™lardan itibaren TÃ¼rk dÄ±ÅŸ politikasÄ±nÄ± etkileyen Ã¶nemli geliÅŸmeleri kavrar." },
            { id: "7.3", ad: "7.3. 1960â€™lardan itibaren TÃ¼rkiyeâ€™de meydana gelen siyasi, ekonomik ve sosyo-kÃ¼ltÃ¼rel geliÅŸmeleri analiz eder." },
        ],
        "8": [
            { id: "8.1", ad: "8.1. 1990 sonrasÄ±nda TÃ¼rkiyeâ€™de meydana gelen ekonomik, siyasi, sosyal ve kÃ¼ltÃ¼rel geliÅŸmeleri kavrar." },
            { id: "8.2", ad: "8.2. 1990 sonrasÄ±nda meydana gelen siyasi geliÅŸmeleri TÃ¼rkiyeâ€™ye etkileri ve dÃ¼nya siyasi konjonktÃ¼rÃ¼ baÄŸlamÄ±nda analiz eder." },
        ]
    };

    function uniteleriYukle() { mockUniteler.forEach(unite => { const option = document.createElement('option'); option.value = unite.id; option.textContent = unite.ad; uniteSecimi.appendChild(option); }); }
    
    function kazanimlariGuncelle(uniteId) {
        kazanimSecimi.innerHTML = '<option value="">LÃ¼tfen bir kazanÄ±m seÃ§iniz</option>';
        olusturButonu.disabled = true;
        kaynakListesi.innerHTML = '<p style="color: #6c757d;">LÃ¼tfen Ã¶nce kazanÄ±m seÃ§iniz</p>';
        if (uniteId) {
            kazanimSecimi.disabled = false;
            const secilenUniteninKazanimlari = mockKazanimlar[uniteId] || [];
            secilenUniteninKazanimlari.forEach(kazanim => {
                const option = document.createElement('option');
                option.value = kazanim.id;
                option.textContent = kazanim.ad;
                kazanimSecimi.appendChild(option);
            });
        } else {
            kazanimSecimi.disabled = true;
        }
    }
    
    async function kaynaklariYukle(unitId, outcomeId) {
        kaynakListesi.innerHTML = '<p class="loading">Kaynaklar yÃ¼kleniyor...</p>';
        olusturButonu.disabled = true;
        try {
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ unit_id: unitId, outcome_id: outcomeId }),
            });
            if (!response.ok) throw new Error('Kaynaklar sunucudan alÄ±namadÄ±.');
            const kaynaklar = await response.json();
            kaynakListesi.innerHTML = '';
            if (kaynaklar.length > 0) {
                kaynaklar.forEach(kaynak => {
                    const type = (kaynak.source_type || 'belge').toLowerCase();
                    let icon = 'ğŸ“œ';
                    if (type === 'gazete') icon = 'ğŸ“°';
                    else if (type === 'hatirat') icon = 'ğŸ“–';
                    else if (type === 'mektup') icon = 'âœ‰ï¸';
                    const kaynakItemHTML = `<div class="kaynak-item" data-source-id="${kaynak.source_id}" onclick="kaynakSecildi(this)"><span class="icon" title="${type.charAt(0).toUpperCase() + type.slice(1)}">${icon}</span><span style="font-weight: normal; cursor: pointer;">${kaynak.source_title}</span></div>`;
                    kaynakListesi.innerHTML += kaynakItemHTML;
                });
            } else {
                kaynakListesi.innerHTML = '<p>Bu kazanÄ±ma ait kaynak bulunamadÄ±</p>';
            }
        } catch (error) {
            console.error("KaynaklarÄ± yÃ¼klerken hata oluÅŸtu:", error);
            kaynakListesi.innerHTML = '<p style="color: red;">Kaynaklar yÃ¼klenemedi.</p>';
        }
    }
    
    function kaynakSecildi(element) {
        document.querySelectorAll('.kaynak-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        olusturButonu.disabled = false;
    }

async function calismaKagidiOlustur() {
        const seciliKaynak = document.querySelector('.kaynak-item.selected');
        if (!seciliKaynak) { alert("LÃ¼tfen bir kaynak seÃ§iniz."); return; }
        const secilenKaynakId = seciliKaynak.dataset.sourceId;
        const secilenUniteId = uniteSecimi.value;
        
        kaynakAlani.innerHTML = '';
        sonucAlani.innerHTML = '<p class="loading">Ã‡alÄ±ÅŸma kaÄŸÄ±dÄ± hazÄ±rlanÄ±yor...</p>';
        kaynakBasligi.style.display = 'none';
        sonucBasligi.style.display = 'none';
        olusturButonu.disabled = true;

        try {
            const istekVerisi = { unit_id: secilenUniteId, source_id: secilenKaynakId };
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(istekVerisi),
            });
            const veri = await response.json();
            if (!response.ok) { throw new Error(veri.message || `Sunucu hatasÄ±`); }
                sonApiCevabi = veri; 

            kaynakBasligi.style.display = 'block';
            sonucBasligi.style.display = 'block';
            indirPdfButonu.style.display = 'block';

            const type = (veri.source_type || '').toLowerCase();
            if (type === 'gazete' || type === 'genelge') {
                kaynakAlani.innerHTML = `<img src="${veri.source_url}" alt="${veri.source_title}" class="kaynak-gorsel">
                                         <p style="white-space: pre-wrap; margin-top: 15px; background-color: #f0f0f0; padding: 10px; border-radius: 4px;">${veri.kullanilan_kaynak}</p>`;
            } else {
                kaynakAlani.textContent = veri.kullanilan_kaynak;
            }
            
            const formatlanmisHtml = formatlaCalismaKagidi(veri.calisma_kagidi);
            sonucAlani.innerHTML = formatlanmisHtml;

        } catch (error) {
            console.error('Hata:', error);
            sonucAlani.innerHTML = `<p style="color: red;">${error.message}</p>`;
            kaynakBasligi.style.display = 'none';
            sonucBasligi.style.display = 'none';
            indirPdfButonu.style.display = 'none';
        } finally {
            olusturButonu.disabled = false;
        }
    }
    
    function formatlaCalismaKagidi(metin) { let htmlCiktisi = ''; const satirlar = metin.split('\n'); satirlar.forEach(satir => { satir = satir.trim(); if (satir === '') return; if (satir.startsWith('Soru') || satir.startsWith('Bu metne gÃ¶re') || satir.startsWith('Cevaplar:')) { htmlCiktisi += `<p><strong>${satir}</strong></p>`; } else if (satir.match(/^[a-d]\)/i)) { htmlCiktisi += `<p style="margin-left: 20px;">${satir}</p>`; } else { htmlCiktisi += `<p>${satir}</p>`; } }); return htmlCiktisi; }

    document.addEventListener('DOMContentLoaded', uniteleriYukle);
    uniteSecimi.addEventListener('change', (event) => {
        kazanimlariGuncelle(event.target.value);
    });
    kazanimSecimi.addEventListener('change', (event) => {
        const secilenUniteId = uniteSecimi.value;
        const secilenKazanimId = event.target.value;
        if (secilenKazanimId) {
            kaynaklariYukle(secilenUniteId, secilenKazanimId);
        } else {
            kaynakListesi.innerHTML = '<p style="color: #6c757d;">LÃ¼tfen Ã¶nce kazanÄ±m seÃ§iniz</p>';
            olusturButonu.disabled = true;
        }
    });
    olusturButonu.addEventListener('click', calismaKagidiOlustur);


indirPdfButonu.addEventListener('click', olusturVeIndirPDF);

async function getImageBase64(url) {
    const response = await fetch(url);
    if (!response.ok) { throw new Error(`Resim yÃ¼klenemedi: ${response.statusText}`); }
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function olusturVeIndirPDF() {
    if (!sonApiCevabi) {
        alert("PDF oluÅŸturmak iÃ§in Ã¶nce bir Ã§alÄ±ÅŸma kaÄŸÄ±dÄ± oluÅŸturmalÄ±sÄ±nÄ±z.");
        return;
    }
    indirPdfButonu.disabled = true;
    indirPdfButonu.textContent = "PDF OluÅŸturuluyor...";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    try {
        const fetchAssetAsBase64 = async (url) => {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`${url} yÃ¼klenemedi.`);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        const [
            loraRegular, loraBold, loraItalic,
            playfairRegular, playfairBold,
            logoBase64
        ] = await Promise.all([
            fetchAssetAsBase64('Lora-Regular.ttf'),
            fetchAssetAsBase64('Lora-Bold.ttf'),
            fetchAssetAsBase64('Lora-Italic.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Regular.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Bold.ttf'),
            fetchAssetAsBase64('logo.png')
        ]);
        
        doc.addFileToVFS('Lora-Regular.ttf', loraRegular.split(',')[1]); doc.addFont('Lora-Regular.ttf', 'Lora', 'normal');
        doc.addFileToVFS('Lora-Bold.ttf', loraBold.split(',')[1]); doc.addFont('Lora-Bold.ttf', 'Lora', 'bold');
        doc.addFileToVFS('Lora-Italic.ttf', loraItalic.split(',')[1]); doc.addFont('Lora-Italic.ttf', 'Lora', 'italic');
        doc.addFileToVFS('PlayfairDisplay-Regular.ttf', playfairRegular.split(',')[1]); doc.addFont('PlayfairDisplay-Regular.ttf', 'Playfair', 'normal');
        doc.addFileToVFS('PlayfairDisplay-Bold.ttf', playfairBold.split(',')[1]); doc.addFont('PlayfairDisplay-Bold.ttf', 'Playfair', 'bold');

        let imageDataUrl = null;
        const imageElement = document.querySelector('#kaynak-alani img');
        if (imageElement && imageElement.src) { imageDataUrl = await fetchAssetAsBase64(imageElement.src); }

        const kazanÄ±mSelect = document.getElementById('kazanim-secimi');
        const seciliKazanimMetni = kazanÄ±mSelect.options[kazanÄ±mSelect.selectedIndex].text.substring(4);
        
        const kaynakKunyesiElement = document.querySelector('.kaynak-item.selected span:last-of-type');
        const kaynakKunyesi = kaynakKunyesiElement ? kaynakKunyesiElement.textContent : "";

        generatePdfContent(doc, sonApiCevabi, imageDataUrl, seciliKazanimMetni, kaynakKunyesi, logoBase64);

        doc.save('calisma_kagidi.pdf');

    } catch (error) {
        console.error("PDF oluÅŸturma hatasÄ±:", error);
        alert(`PDF oluÅŸturulurken bir hata oluÅŸtu: ${error.message}`);
    } finally {
        indirPdfButonu.disabled = false;
        indirPdfButonu.textContent = "PDF Olarak Ä°ndir";
    }
}

function generatePdfContent(doc, veri, imageDataUrl, kazanÄ±mMetni, kaynakKunyesi, logoBase64) {
    const solKenar = 55;
    const sayfaGenisligi = doc.internal.pageSize.getWidth() - (solKenar * 2);
    let yPozisyonu = 70;

    const sayfaKontrolu = (gerekliBosluk) => {
        if (yPozisyonu + gerekliBosluk > doc.internal.pageSize.getHeight() - 80) {
            altBilgiEkle(doc);
            doc.addPage();
            yPozisyonu = 70;
        }
    };

    doc.addImage(logoBase64, 'PNG', solKenar - 15, yPozisyonu - 35, 35, 35);
    doc.setFont('Playfair', 'bold'); doc.setFontSize(24); doc.setTextColor(42, 77, 122);
    doc.text('T.C. Ä°nkÄ±lap Tarihi ve AtatÃ¼rkÃ§Ã¼lÃ¼k Dersi', doc.internal.pageSize.getWidth() / 2, yPozisyonu, { align: 'center' });
    yPozisyonu += 28;

    doc.setFont('Lora', 'italic'); doc.setFontSize(10); doc.setTextColor(120);
    const kazanÄ±mSatirlari = doc.splitTextToSize(`KazanÄ±m: ${kazanÄ±mMetni}`, sayfaGenisligi - 40);
    doc.text(kazanÄ±mSatirlari, doc.internal.pageSize.getWidth() / 2, yPozisyonu, { align: 'center' });
    yPozisyonu += (kazanÄ±mSatirlari.length * 12) + 15;
    
    doc.setDrawColor(220, 220, 220);
    doc.line(solKenar, yPozisyonu, doc.internal.pageSize.getWidth() - solKenar, yPozisyonu);
    yPozisyonu += 30;

sayfaKontrolu(50);
    doc.setFont('Playfair', 'bold'); doc.setFontSize(16);
    doc.setTextColor(42, 77, 122);
    doc.text('Tarihsel Kaynak', solKenar, yPozisyonu);
    yPozisyonu += 25;

    if (imageDataUrl) {
        const imgProps = doc.getImageProperties(imageDataUrl);
        const imgHeight = sayfaGenisligi * imgProps.height / imgProps.width;
        sayfaKontrolu(imgHeight);
        doc.addImage(imageDataUrl, 'JPEG', solKenar, yPozisyonu, sayfaGenisligi, imgHeight);
        yPozisyonu += imgHeight + 15;
    }
    
    if (veri.kullanilan_kaynak) {
        doc.setFont('Lora', 'italic');
        doc.setFontSize(11);
        doc.setTextColor(150);

        const metinSatirlari = doc.splitTextToSize(`"${veri.kullanilan_kaynak}"`, sayfaGenisligi);
        metinSatirlari.forEach(satir => {
            sayfaKontrolu(11 * 1.35);
            doc.text(satir, solKenar, yPozisyonu);
            yPozisyonu += 11 * 1.35;
        });
        yPozisyonu += 10;
    }
    doc.setFont('Lora', 'italic'); doc.setFontSize(9); doc.setTextColor(42, 77, 122);
    doc.text(`AlÄ±ntÄ±lanan Belge: ${kaynakKunyesi}`, sayfaGenisligi + solKenar, yPozisyonu, { align: 'right' });
    yPozisyonu += 30;

    sayfaKontrolu(50);
    doc.setFont('Playfair', 'bold'); doc.setFontSize(16); doc.setTextColor(42, 77, 122);
    doc.text('Analiz ve Yorumlama SorularÄ±', solKenar, yPozisyonu);
    yPozisyonu += 25;

    const sorular = (veri.calisma_kagidi || "").split('\n').filter(s => s.trim().match(/^\d+\./));
    sorular.forEach((satir, index) => {
        const soruMetni = satir.substring(satir.indexOf('.') + 1).trim();
        const soruNumarasi = `${index + 1}.`;
        
        sayfaKontrolu(30);
        doc.setFont('Playfair', 'bold'); doc.setFontSize(14); doc.setTextColor(42, 77, 122);
        doc.text(soruNumarasi, solKenar, yPozisyonu);
        
        doc.setFont('Lora', 'normal'); doc.setFontSize(11); doc.setTextColor(34, 34, 34);
        const soruSatirlari = doc.splitTextToSize(soruMetni, sayfaGenisligi - 25);
        soruSatirlari.forEach(soruSatiri => {
            sayfaKontrolu(11 * 1.35);
            doc.text(soruSatiri, solKenar + 25, yPozisyonu);
            yPozisyonu += 11 * 1.35;
        });
        yPozisyonu += 20;
    });

    altBilgiEkle(doc);
}

function altBilgiEkle(doc) {
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFont('Lora', 'italic'); doc.setFontSize(8); doc.setTextColor(150);
        const footerText = `AkÄ±llÄ± Ã‡alÄ±ÅŸma KaÄŸÄ±dÄ± AsistanÄ± Â© 2025 | Sayfa ${i} / ${totalPages}`;
        doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 30, { align: 'center' });
    }
}
    indirPdfButonu.addEventListener('click', olusturVeIndirPDF);
</script>
</body>
</html>