<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞nkƒ±lap Tarihi Akƒ±llƒ± √áalƒ±≈üma Kaƒüƒ±dƒ± Asistanƒ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        h1 { color: #0056b3; text-align: center; }
        select, button { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; margin-top: 5px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
        .kaynak-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; border: 1px solid transparent; }
        .kaynak-item:hover { background-color: #f0f0f0; }
        .kaynak-item.selected { border-color: #007bff; background-color: #e7f3ff; }
        .kaynak-item .icon { font-size: 24px; margin-right: 10px; }
        .kaynak-gorsel { max-width: 100%; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ƒ∞nkƒ±lap Tarihi Akƒ±llƒ± √áalƒ±≈üma Kaƒüƒ±dƒ± Asistanƒ±</h1>
        <div class="form-group"><label for="unite-secimi">√únite Se√ßimi:</label><select id="unite-secimi"><option value="">L√ºtfen bir √ºnite se√ßiniz</option></select></div>
        <div class="form-group"><label for="kazanim-secimi">Kazanƒ±m Se√ßimi:</label><select id="kazanim-secimi" disabled><option value="">L√ºtfen √∂nce √ºnite se√ßiniz</option></select></div>
        
        <div class="form-group">
            <label for="kaynak-listesi">Kaynak Se√ßimi:</label>
            <div id="kaynak-listesi" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 50px;">
                <p style="color: #6c757d;">L√ºtfen √∂nce kazanƒ±m se√ßiniz</p>
            </div>
        </div>

        <button id="olustur-butonu" disabled>√áalƒ±≈üma Kaƒüƒ±dƒ± Olu≈ütur</button>
        <button id="indir-pdf-butonu" style="display: none; margin-top: 10px; background-color: #28a745;">PDF Olarak ƒ∞ndir</button>

        <div id="kaynak-basligi" style="margin-top: 20px; display: none;"><h3>Kullanƒ±lan Birinci Elden Kaynak:</h3></div>
        <div id="kaynak-alani"></div>
        <div id="sonuc-basligi" style="margin-top: 20px; display: none;"><h3>Olu≈üturulan √áalƒ±≈üma Kaƒüƒ±dƒ±:</h3></div>
        <div id="sonuc-alani"></div>
    </div>

<script>
    const API_ENDPOINT_URL = 'https://duwr3ymxi6.execute-api.eu-central-1.amazonaws.com/';

    let sonApiCevabi = null;

    const uniteSecimi = document.getElementById('unite-secimi');
    const kazanimSecimi = document.getElementById('kazanim-secimi');
    const kaynakListesi = document.getElementById('kaynak-listesi');
    const olusturButonu = document.getElementById('olustur-butonu');
    const kaynakBasligi = document.getElementById('kaynak-basligi');
    const kaynakAlani = document.getElementById('kaynak-alani');
    const sonucBasligi = document.getElementById('sonuc-basligi');
    const sonucAlani = document.getElementById('sonuc-alani');
    const indirPdfButonu = document.getElementById('indir-pdf-butonu');

    const mockUniteler = [
        { id: "1", ad: "1. 20. Y√ºzyƒ±l Ba≈ülarƒ±nda Osmanlƒ± Devleti ve D√ºnya" },
        { id: "2", ad: "2. Milli M√ºcadele" },
        { id: "3", ad: "3. Atat√ºrk√ß√ºl√ºk ve T√ºrk ƒ∞nkƒ±labƒ±" },
        { id: "4", ad: "4. ƒ∞ki Sava≈ü Arasƒ±ndaki D√∂nemde T√ºrkiye ve D√ºnya" },
        { id: "5", ad: "5. II.D√ºnya Sava≈üƒ± S√ºrecinde T√ºrkiye ve D√ºnya" },
        { id: "6", ad: "6. II.D√ºnya Sava≈üƒ± Sonrasƒ±nda T√ºrkiye ve D√ºnya" },
        { id: "7", ad: "7. Toplumsal Devrim √áaƒüƒ±nda D√ºnya ve T√ºrkiye" },
        { id: "8", ad: "8. 21. Y√ºzyƒ±lƒ±n E≈üiƒüinde T√ºrkiye ve D√ºnya" }
    ];

    const mockKazanimlar = {
        "1": [
            { id: "1.1", ad: "1.1. Mustafa Kemal‚Äôin Birinci D√ºnya Sava≈üƒ±‚Äôna kadarki eƒüitim ve askerlik hayatƒ±nƒ± i√ßinde bulunduƒüu toplumun siyasi, sosyal ve k√ºlt√ºrel yapƒ±sƒ± ile ili≈ükilendirir" },
            { id: "1.2", ad: "1.2. 20. y√ºzyƒ±l ba≈ülarƒ±nda Osmanlƒ± Devleti‚Äônin siyasi, sosyal ve ekonomik durumunu analiz eder." },
            { id: "1.3", ad: "1.3. I. D√ºnya Sava≈üƒ± s√ºrecinde Osmanlƒ± Devleti‚Äônin durumunu siyasi, asker√Æ ve sosyal a√ßƒ±lardan analiz eder." },
            { id: "1.4", ad: "1.4. I. D√ºnya Sava≈üƒ±‚Äônƒ±n sonu√ßlarƒ±nƒ± Osmanlƒ± Devleti ve Batƒ±lƒ± devletler a√ßƒ±sƒ±ndan deƒüerlendirir." }
        ],
        "2": [
            { id: "2.1", ad: "2.1. Kuvay-ƒ± Mill√Æye hareketinin olu≈üumundan B√ºy√ºk Millet Meclisinin a√ßƒ±lƒ±≈üƒ±na kadar olan s√ºre√ßte meydana gelen geli≈ümeleri a√ßƒ±klar." },
            { id: "2.2", ad: "2.2. B√ºy√ºk Millet Meclisinin a√ßƒ±lƒ±≈ü s√ºrecini ve sonrasƒ±nda meydana gelen geli≈ümeleri kavrar." },
            { id: "2.3", ad: "2.3. Sevr Antla≈ümasƒ±‚Äônƒ±n Mill√Æ M√ºcadele s√ºrecine etkilerini analiz eder." },
            { id: "2.4", ad: "2.4. Doƒüu ve G√ºney Cephelerinde verilen m√ºcadelelerin √ºlkemizin baƒüƒ±msƒ±zlƒ±k s√ºrecine katkƒ±larƒ±nƒ± kavrar." },
            { id: "2.5", ad: "2.5. D√ºzenli ordunun kurulmasƒ±ndan Mudanya Ate≈ükes Antla≈ümasƒ±‚Äôna kadar meydana gelen geli≈ümeleri T√ºrkiye‚Äônin baƒüƒ±msƒ±zlƒ±k s√ºrecine katkƒ±larƒ± a√ßƒ±sƒ±ndan analiz eder." },
            { id: "2.6", ad: "2.6. Mill√Æ M√ºcadele sonucunda kazanƒ±lan diplomatik ba≈üarƒ±larƒ± √ºlkemizin baƒüƒ±msƒ±zlƒ±ƒüƒ± a√ßƒ±sƒ±ndan deƒüerlendirir.2.6. Mill√Æ M√ºcadele sonucunda kazanƒ±lan diplomatik ba≈üarƒ±larƒ± √ºlkemizin baƒüƒ±msƒ±zlƒ±ƒüƒ± a√ßƒ±sƒ±ndan deƒüerlendirir." },
            { id: "2.7", ad: "2.7. Mill√Æ M√ºcadele s√ºrecine katkƒ±da bulunmu≈ü √∂nemli ≈üahsiyetlerin ki≈üilik √∂zellikleri ile faaliyetlerini ili≈ükilendirir." }
        ],
        "3": [
            { id: "3.1", ad: "3.1. √áaƒüda≈üla≈üan T√ºrkiye‚Äônin temeli olan Atat√ºrk ilkelerini kavrar." },
            { id: "3.2", ad: "3.2. Siyasi alanda meydana gelen geli≈ümeleri kavrar." },
            { id: "3.3", ad: "3.3. Hukuk alanƒ±nda meydana gelen geli≈ümelerin T√ºrk toplumunda meydana getirdiƒüi deƒüi≈üimleri kavrar." },
            { id: "3.4", ad: "3.4. Eƒüitim ve k√ºlt√ºr alanƒ±nda yapƒ±lan inkƒ±laplarƒ± ve geli≈ümeleri kavrar." },
            { id: "3.5", ad: "3.5. Toplumsal alanda yapƒ±lan inkƒ±laplarƒ± ve meydana gelen geli≈ümeleri kavrar." },
            { id: "3.6", ad: "3.6. Ekonomi alanƒ±nda meydana gelen geli≈ümeleri kavrar." },
            { id: "3.7", ad: "3.7. Atat√ºrk D√∂nemi‚Äônde saƒülƒ±k alanƒ±nda yapƒ±lan √ßalƒ±≈ümalarƒ± kavrar." },
            { id: "3.8", ad: "3.7. Atat√ºrk ilke ve inkƒ±laplarƒ±nƒ± olu≈üturan temel esaslarƒ± Atat√ºrk√ß√º d√º≈ü√ºnce sistemi a√ßƒ±sƒ±ndan analiz eder." },
        ],
        "4": [
            { id: "4.1", ad: "4.1. Atat√ºrk D√∂nemi‚Äônde T√ºrkiye Cumhuriyeti‚Äônin i√ß politikasƒ±ndaki √∂nemli geli≈ümeleri a√ßƒ±klar." },
            { id: "4.2", ad: "4.2. Atat√ºrk D√∂nemi‚Äônde (1923-1938) T√ºrkiye Cumhuriyeti‚Äônin dƒ±≈ü politikasƒ±ndaki ba≈ülƒ±ca geli≈ümeleri a√ßƒ±klar. " },
            { id: "4.3", ad: "4.3. ƒ∞ki d√ºnya sava≈üƒ± arasƒ±ndaki d√∂nemde d√ºnyada meydana gelen siyasi ve ekonomik geli≈ümeleri kavrar." },
        ],
        "5": [
            { id: "5.1", ad: "5.1. II. D√ºnya Sava≈üƒ±‚Äônƒ±n sebepleri, ba≈ülamasƒ± ve yayƒ±lmasƒ±yla ilgili ba≈ülƒ±ca geli≈ümeleri kavrar" },
            { id: "5.2", ad: "5.2. II. D√ºnya Sava≈üƒ± s√ºrecinde T√ºrkiye‚Äônin izlediƒüi siyaset ile sava≈üƒ±n T√ºrkiye √ºzerindeki ekonomik ve toplumsal etkilerini analiz eder." },
            { id: "5.3", ad: "5.3. II. D√ºnya Sava≈üƒ±‚Äônƒ±n sonu√ßlarƒ±nƒ± deƒüerlendirir." },
        ],
        "6": [
            { id: "6.1", ad: "6.1. 1945-1950 yƒ±llarƒ± arasƒ±nda T√ºrkiye‚Äôde meydana gelen siyasi, sosyal ve ekonomik geli≈ümeleri kavrar." },
            { id: "6.2", ad: "6.2. II. D√ºnya Sava≈üƒ± sonrasƒ± d√∂nemde uluslararasƒ± ili≈ükilerde ve T√ºrk dƒ±≈ü politikasƒ±nda meydana gelen geli≈ümeleri kavrar." },
            { id: "6.3", ad: "6.3. 1950‚Äôler T√ºrkiye‚Äôsinde meydana gelen siyasi, sosyal ve ekonomik geli≈ümeleri analiz eder." },
        ],
        "7": [
            { id: "7.1", ad: "7.1. 1960 sonrasƒ±nda d√ºnya siyasetinde ortaya √ßƒ±kan geli≈ümeleri a√ßƒ±klar." },
            { id: "7.2", ad: "7.2. 1960‚Äôlardan itibaren T√ºrk dƒ±≈ü politikasƒ±nƒ± etkileyen √∂nemli geli≈ümeleri kavrar." },
            { id: "7.3", ad: "7.3. 1960‚Äôlardan itibaren T√ºrkiye‚Äôde meydana gelen siyasi, ekonomik ve sosyo-k√ºlt√ºrel geli≈ümeleri analiz eder." },
        ],
        "8": [
            { id: "8.1", ad: "8.1. 1990 sonrasƒ±nda T√ºrkiye‚Äôde meydana gelen ekonomik, siyasi, sosyal ve k√ºlt√ºrel geli≈ümeleri kavrar." },
            { id: "8.2", ad: "8.2. 1990 sonrasƒ±nda meydana gelen siyasi geli≈ümeleri T√ºrkiye‚Äôye etkileri ve d√ºnya siyasi konjonkt√ºr√º baƒülamƒ±nda analiz eder." },
        ]
    };

    function uniteleriYukle() { mockUniteler.forEach(unite => { const option = document.createElement('option'); option.value = unite.id; option.textContent = unite.ad; uniteSecimi.appendChild(option); }); }
    
    function kazanimlariGuncelle(uniteId) {
        kazanimSecimi.innerHTML = '<option value="">L√ºtfen bir kazanƒ±m se√ßiniz</option>';
        olusturButonu.disabled = true;
        kaynakListesi.innerHTML = '<p style="color: #6c757d;">L√ºtfen √∂nce kazanƒ±m se√ßiniz</p>';
        if (uniteId) {
            kazanimSecimi.disabled = false;
            const secilenUniteninKazanimlari = mockKazanimlar[uniteId] || [];
            secilenUniteninKazanimlari.forEach(kazanim => {
                const option = document.createElement('option');
                option.value = kazanim.id;
                option.textContent = kazanim.ad;
                kazanimSecimi.appendChild(option);
            });
        } else {
            kazanimSecimi.disabled = true;
        }
    }
    
    async function kaynaklariYukle(unitId, outcomeId) {
        kaynakListesi.innerHTML = '<p class="loading">Kaynaklar y√ºkleniyor...</p>';
        olusturButonu.disabled = true;
        try {
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ unit_id: unitId, outcome_id: outcomeId }),
            });
            if (!response.ok) throw new Error('Kaynaklar sunucudan alƒ±namadƒ±.');
            const kaynaklar = await response.json();
            kaynakListesi.innerHTML = '';
            if (kaynaklar.length > 0) {
                kaynaklar.forEach(kaynak => {
                    const type = (kaynak.source_type || 'belge').toLowerCase();
                    let icon = 'üìú';
                    if (type === 'gazete') icon = 'üì∞';
                    else if (type === 'hatirat') icon = 'üìñ';
                    else if (type === 'mektup') icon = '‚úâÔ∏è';
                    const kaynakItemHTML = `<div class="kaynak-item" data-source-id="${kaynak.source_id}" onclick="kaynakSecildi(this)"><span class="icon" title="${type.charAt(0).toUpperCase() + type.slice(1)}">${icon}</span><span style="font-weight: normal; cursor: pointer;">${kaynak.source_title}</span></div>`;
                    kaynakListesi.innerHTML += kaynakItemHTML;
                });
            } else {
                kaynakListesi.innerHTML = '<p>Bu kazanƒ±ma ait kaynak bulunamadƒ±</p>';
            }
        } catch (error) {
            console.error("Kaynaklarƒ± y√ºklerken hata olu≈ütu:", error);
            kaynakListesi.innerHTML = '<p style="color: red;">Kaynaklar y√ºklenemedi.</p>';
        }
    }
    
    function kaynakSecildi(element) {
        document.querySelectorAll('.kaynak-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        olusturButonu.disabled = false;
    }

async function calismaKagidiOlustur() {
        const seciliKaynak = document.querySelector('.kaynak-item.selected');
        if (!seciliKaynak) { alert("L√ºtfen bir kaynak se√ßiniz."); return; }
        const secilenKaynakId = seciliKaynak.dataset.sourceId;
        const secilenUniteId = uniteSecimi.value;
        
        kaynakAlani.innerHTML = '';
        sonucAlani.innerHTML = '<p class="loading">√áalƒ±≈üma kaƒüƒ±dƒ± hazƒ±rlanƒ±yor...</p>';
        kaynakBasligi.style.display = 'none';
        sonucBasligi.style.display = 'none';
        olusturButonu.disabled = true;

        try {
            const istekVerisi = { unit_id: secilenUniteId, source_id: secilenKaynakId };
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(istekVerisi),
            });
            const veri = await response.json();
            if (!response.ok) { throw new Error(veri.message || `Sunucu hatasƒ±`); }
                sonApiCevabi = veri; 

            kaynakBasligi.style.display = 'block';
            sonucBasligi.style.display = 'block';
            indirPdfButonu.style.display = 'block';

            const type = (veri.source_type || '').toLowerCase();
            if (type === 'gazete' || type === 'genelge') {
                kaynakAlani.innerHTML = `<img src="${veri.source_url}" alt="${veri.source_title}" class="kaynak-gorsel">
                                         <p style="white-space: pre-wrap; margin-top: 15px; background-color: #f0f0f0; padding: 10px; border-radius: 4px;">${veri.kullanilan_kaynak}</p>`;
            } else {
                kaynakAlani.textContent = veri.kullanilan_kaynak;
            }
            
            const formatlanmisHtml = formatlaCalismaKagidi(veri.calisma_kagidi);
            sonucAlani.innerHTML = formatlanmisHtml;

        } catch (error) {
            console.error('Hata:', error);
            sonucAlani.innerHTML = `<p style="color: red;">${error.message}</p>`;
            kaynakBasligi.style.display = 'none';
            sonucBasligi.style.display = 'none';
            indirPdfButonu.style.display = 'none';
        } finally {
            olusturButonu.disabled = false;
        }
    }
    
    function formatlaCalismaKagidi(metin) { let htmlCiktisi = ''; const satirlar = metin.split('\n'); satirlar.forEach(satir => { satir = satir.trim(); if (satir === '') return; if (satir.startsWith('Soru') || satir.startsWith('Bu metne g√∂re') || satir.startsWith('Cevaplar:')) { htmlCiktisi += `<p><strong>${satir}</strong></p>`; } else if (satir.match(/^[a-d]\)/i)) { htmlCiktisi += `<p style="margin-left: 20px;">${satir}</p>`; } else { htmlCiktisi += `<p>${satir}</p>`; } }); return htmlCiktisi; }

    document.addEventListener('DOMContentLoaded', uniteleriYukle);
    uniteSecimi.addEventListener('change', (event) => {
        kazanimlariGuncelle(event.target.value);
    });
    kazanimSecimi.addEventListener('change', (event) => {
        const secilenUniteId = uniteSecimi.value;
        const secilenKazanimId = event.target.value;
        if (secilenKazanimId) {
            kaynaklariYukle(secilenUniteId, secilenKazanimId);
        } else {
            kaynakListesi.innerHTML = '<p style="color: #6c757d;">L√ºtfen √∂nce kazanƒ±m se√ßiniz</p>';
            olusturButonu.disabled = true;
        }
    });
    olusturButonu.addEventListener('click', calismaKagidiOlustur);


indirPdfButonu.addEventListener('click', olusturVeIndirPDF);

async function getImageBase64(url) {
    const response = await fetch(url);
    if (!response.ok) { throw new Error(`Resim y√ºklenemedi: ${response.statusText}`); }
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

const PDF_SETTINGS = {
    marginLeft: 55,
    marginRight: 55,
    marginTop: 70,
    marginBottom: 120,
    headerTopMargin: 70, 
    lineHeightMultiplier: 1.35,
    titleColor: [42, 77, 122],
    textColor: [34, 34, 34],
    altTextColor: [120, 120, 120], 
    mediumGray: [100, 100, 100], 
    darkGray: [50, 50, 50],
    sourceLineColor: [150, 150, 150],
    sectionLineColor: [220, 220, 220],
    underlineColor: [42, 77, 122],
    logoOffset: 15,
    logoSize: 35,
    kazanƒ±mLineHeight: 1.35,
    kaynakAlƒ±ntƒ±MarginLeft: 20,
    soruNumarasƒ±Offset: 25,
    soruAltCizgiSayƒ±sƒ±: 4, 
    soruCevapCizgiRengi: [200, 200, 200],
    altBilgiYOffset: 30, 
    kazanƒ±mFontSize: 12, 
    quoteFontSize: 10,   
    quoteLineHeightMultiplier: 1.5,
    footerFontSize: 9,   
    sectionTitleSize: 16, 
    mainBodyFontSize: 11, 
    sourceSectionTitleSpacing: 15, 
    imageBottomSpacing: 20, 
    minUsableImageHeight: 80, 
    imagePaddingHorizontal: 15,
    sourceSectionTitleLineLength: 100,
    questionSectionTitleLineLength: 200,
    lineThickness: 1,
    headerTopMargin: 50
};

async function olusturVeIndirPDF() {

    if (!sonApiCevabi) {
        alert("PDF olu≈üturmak i√ßin √∂nce bir √ßalƒ±≈üma kaƒüƒ±dƒ± olu≈üturmalƒ±sƒ±nƒ±z.");
        return;
    }
    if (indirPdfButonu) { 
        indirPdfButonu.disabled = true;
        indirPdfButonu.textContent = "PDF Olu≈üturuluyor...";
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    try {
        const fetchAssetAsBase64 = async (url) => {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Varlƒ±k y√ºklenemedi: ${url}. HTTP Stat√º: ${response.status} ${response.statusText}`);
            }
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        const [
            loraRegular, loraBold, loraItalic,
            playfairRegular, playfairBold,
            logoBase64
        ] = await Promise.all([
            fetchAssetAsBase64('Lora-Regular.ttf'),
            fetchAssetAsBase64('Lora-Bold.ttf'),
            fetchAssetAsBase64('Lora-Italic.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Regular.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Bold.ttf'),
            fetchAssetAsBase64('logo.png')
        ]);
        
        doc.addFileToVFS('Lora-Regular.ttf', loraRegular.split(',')[1]); doc.addFont('Lora-Regular.ttf', 'Lora', 'normal');
        doc.addFileToVFS('Lora-Bold.ttf', loraBold.split(',')[1]); doc.addFont('Lora-Bold.ttf', 'Lora', 'bold');
        doc.addFileToVFS('Lora-Italic.ttf', loraItalic.split(',')[1]); doc.addFont('Lora-Italic.ttf', 'Lora', 'italic');
        doc.addFileToVFS('PlayfairDisplay-Regular.ttf', playfairRegular.split(',')[1]); doc.addFont('PlayfairDisplay-Regular.ttf', 'Playfair', 'normal');
        doc.addFileToVFS('PlayfairDisplay-Bold.ttf', playfairBold.split(',')[1]); doc.addFont('PlayfairDisplay-Bold.ttf', 'Playfair', 'bold');

        let imageDataUrl = null;
        const imageElement = document.querySelector('#kaynak-alani img'); 
        if (imageElement && imageElement.src) { imageDataUrl = await fetchAssetAsBase64(imageElement.src); }

        const kazanƒ±mSelect = document.getElementById('kazanim-secimi'); 
        const seciliKazanimMetni = kazanƒ±mSelect && kazanƒ±mSelect.options[kazanƒ±mSelect.selectedIndex] ? kazanƒ±mSelect.options[kazanƒ±mSelect.selectedIndex].text.substring(4) : "Belirtilmemi≈ü Kazanƒ±m";
        
        const kaynakKunyesiElement = document.querySelector('.kaynak-item.selected span:last-of-type'); 
        const kaynakKunyesi = kaynakKunyesiElement ? kaynakKunyesiElement.textContent : "";

        await generatePdfContent(doc, sonApiCevabi, imageDataUrl, seciliKazanimMetni, kaynakKunyesi, logoBase64);

        altBilgiEkle(doc); 
        
        doc.save('calisma_kagidi.pdf');

    } catch (error) {
        console.error("PDF olu≈üturma hatasƒ±:", error);
        alert(`PDF olu≈üturulurken bir hata olu≈ütu: ${error.message}`);
    } finally {
        if (indirPdfButonu) { 
            indirPdfButonu.disabled = false;
            indirPdfButonu.textContent = "PDF Olarak ƒ∞ndir";
        }
    }
}

let currentFont = { family: 'Lora', style: 'normal', size: 11, color: PDF_SETTINGS.textColor }; 

function applyCurrentFont(doc) {
    doc.setFont(currentFont.family, currentFont.style);
    doc.setFontSize(currentFont.size);
    doc.setTextColor(currentFont.color[0], currentFont.color[1], currentFont.color[2]);
}

const sayfaKontrolu = (doc, yPozisyonu, gerekliBosluk) => {
    const sayfaAltSiniri = doc.internal.pageSize.getHeight() - PDF_SETTINGS.marginBottom;

    if (yPozisyonu + gerekliBosluk > sayfaAltSiniri) {
        doc.addPage();
        yPozisyonu = PDF_SETTINGS.marginTop; 
        applyCurrentFont(doc); 
    }
    return yPozisyonu; 
};
async function generatePdfContent(doc, veri, imageDataUrl, kazanƒ±mMetni, kaynakKunyesi, logoBase64) {
    let yPozisyonu = PDF_SETTINGS.headerTopMargin;

    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;
    const sayfaGenisligi = sagKenar - solKenar;

    yPozisyonu = addHeaderSection(doc, yPozisyonu, logoBase64, kazanƒ±mMetni, sayfaGenisligi);


    let tempYPozisyonuForSource = yPozisyonu;

    const boxPadding = 15;
    const contentWidthInsideBox = sayfaGenisligi - (boxPadding * 2); 
    
    let estimatedSourceContentHeight = 0; 
    let estimatedSourceBoxHeight = 0; 
    let estimatedSourceSectionTitleHeight = PDF_SETTINGS.sectionTitleSize + 5 + PDF_SETTINGS.sourceSectionTitleSpacing;

    let tempCalculatedImageHeight = 0;
    let tempActualImageWidth = 0;
    if (imageDataUrl) {
        const imgProps = doc.getImageProperties(imageDataUrl);
        const originalImageRatio = imgProps.width / imgProps.height;
        tempActualImageWidth = contentWidthInsideBox - (PDF_SETTINGS.imagePaddingHorizontal * 2);
        if (imgProps.width < tempActualImageWidth) {
            tempActualImageWidth = imgProps.width;
            tempCalculatedImageHeight = imgProps.height;
        } else {
            tempCalculatedImageHeight = tempActualImageWidth / originalImageRatio;
        }
        if (tempCalculatedImageHeight < PDF_SETTINGS.minUsableImageHeight) {
            tempCalculatedImageHeight = 0;
        } else {
            estimatedSourceContentHeight += tempCalculatedImageHeight + PDF_SETTINGS.imageBottomSpacing;
        }
    }

    if (veri.kullanilan_kaynak) {
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.quoteFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc); 
        const alintiKutuIciGenislik = contentWidthInsideBox - PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft; 
        const metinSatirlari = doc.splitTextToSize(`"${veri.kullanilan_kaynak}"`, alintiKutuIciGenislik);
        estimatedSourceContentHeight += (metinSatirlari.length * currentFont.size * PDF_SETTINGS.quoteLineHeightMultiplier); 
        estimatedSourceContentHeight += 15;
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.footerFontSize, color: PDF_SETTINGS.mediumGray };
        applyCurrentFont(doc);
        estimatedSourceContentHeight += (currentFont.size * PDF_SETTINGS.lineHeightMultiplier); 
        estimatedSourceContentHeight += 30;
    }

    if (estimatedSourceContentHeight > 0) { 
        estimatedSourceBoxHeight = estimatedSourceContentHeight + (boxPadding * 2);
    }

    const totalRequiredSourceSectionHeight = estimatedSourceSectionTitleHeight + estimatedSourceBoxHeight + 10;

    yPozisyonu = sayfaKontrolu(doc, yPozisyonu, totalRequiredSourceSectionHeight);

    yPozisyonu = await addSourceSection(doc, yPozisyonu, imageDataUrl, veri.kullanilan_kaynak, kaynakKunyesi, sayfaGenisligi, true); // Yeni parametre: `alreadyControlledForPage`

    yPozisyonu = addQuestionSection(doc, yPozisyonu, veri.calisma_kagidi, sayfaGenisligi);
}
function addHeaderSection(doc, startY, logoBase64, kazanƒ±mMetni, sayfaGenisligi) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;

    currentFont = { family: 'Playfair', style: 'bold', size: 24, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.addImage(logoBase64, 'PNG', solKenar, y - PDF_SETTINGS.logoOffset, PDF_SETTINGS.logoSize, PDF_SETTINGS.logoSize);
    doc.text('T.C. ƒ∞nkƒ±lap Tarihi ve Atat√ºrk√ß√ºl√ºk Dersi', solKenar + PDF_SETTINGS.logoSize + 10, y, { align: 'left' });
    y += 28;

    currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.kazanƒ±mFontSize, color: PDF_SETTINGS.mediumGray };
    applyCurrentFont(doc);
    const kazanƒ±mSatirlari = doc.splitTextToSize(`Kazanƒ±m: ${kazanƒ±mMetni}`, sayfaGenisligi);
    doc.text(kazanƒ±mSatirlari, solKenar, y, { align: 'left' });
    y += (kazanƒ±mSatirlari.length * currentFont.size * PDF_SETTINGS.kazanƒ±mLineHeight) + 10; 

    doc.setDrawColor(PDF_SETTINGS.sectionLineColor[0], PDF_SETTINGS.sectionLineColor[1], PDF_SETTINGS.sectionLineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y, doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight, y);
    y += 15; 
    return y;
}

async function addSourceSection(doc, startY, imageDataUrl, kullanilanKaynakMetni, kaynakKunyesi, sayfaGenisligi, alreadyControlledForPage = false) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;

    const titleHeight = PDF_SETTINGS.sectionTitleSize + 5; 
    const titleAndSpacingHeight = titleHeight + PDF_SETTINGS.sourceSectionTitleSpacing;

    const boxPadding = 15;
    const contentWidthInsideBox = sayfaGenisligi - (boxPadding * 2); 
    let calculatedImageHeight = 0;
    let actualImageWidth = 0; 
    let imageSectionHeight = 0; 

    if (imageDataUrl) {
        const imgProps = doc.getImageProperties(imageDataUrl);
        const originalImageRatio = imgProps.width / imgProps.height;

        actualImageWidth = contentWidthInsideBox - (PDF_SETTINGS.imagePaddingHorizontal * 2); 
        
        if (imgProps.width < actualImageWidth) {
            actualImageWidth = imgProps.width; 
            calculatedImageHeight = imgProps.height; 
        } else {
            calculatedImageHeight = actualImageWidth / originalImageRatio;
        }
        
        if (calculatedImageHeight < PDF_SETTINGS.minUsableImageHeight) {
            calculatedImageHeight = 0; 
            actualImageWidth = 0; 
        } else {
            imageSectionHeight = calculatedImageHeight + PDF_SETTINGS.imageBottomSpacing;
        }
    }

    let textSectionHeight = 0;
    if (kullanilanKaynakMetni) {
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.quoteFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);
        const alintiKutuIciGenislik = contentWidthInsideBox - PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft; 
        const metinSatirlari = doc.splitTextToSize(`"${kullanilanKaynakMetni}"`, alintiKutuIciGenislik);
        textSectionHeight += (metinSatirlari.length * currentFont.size * PDF_SETTINGS.quoteLineHeightMultiplier); 
        textSectionHeight += 15; 
        
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.footerFontSize, color: PDF_SETTINGS.mediumGray };
        applyCurrentFont(doc);
        textSectionHeight += (currentFont.size * PDF_SETTINGS.lineHeightMultiplier); 
        textSectionHeight += 30;
    }

    let requiredContentHeight = imageSectionHeight + textSectionHeight;
    let requiredBoxHeight = requiredContentHeight > 0 ? (requiredContentHeight + (boxPadding * 2)) : 0; 

    if (requiredContentHeight === 0) {
        y = sayfaKontrolu(doc, y, titleAndSpacingHeight);
        
        currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.sectionTitleSize, color: PDF_SETTINGS.titleColor };
        applyCurrentFont(doc);
        doc.text('Tarihsel Kaynak', solKenar, y);
        doc.setDrawColor(PDF_SETTINGS.underlineColor[0], PDF_SETTINGS.underlineColor[1], PDF_SETTINGS.underlineColor[2]);
        doc.setLineWidth(PDF_SETTINGS.lineThickness);
        doc.line(solKenar, y + 5, solKenar + PDF_SETTINGS.sourceSectionTitleLineLength, y + 5);
        y += PDF_SETTINGS.sourceSectionTitleSpacing; 
        
        return y;
    }


    y = sayfaKontrolu(doc, y, titleAndSpacingHeight + requiredBoxHeight + 10); 
    
    currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.sectionTitleSize, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.text('Tarihsel Kaynak', solKenar, y);
    doc.setDrawColor(PDF_SETTINGS.underlineColor[0], PDF_SETTINGS.underlineColor[1], PDF_SETTINGS.underlineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y + 5, solKenar + PDF_SETTINGS.sourceSectionTitleLineLength, y + 5);
    y += PDF_SETTINGS.sourceSectionTitleSpacing; 

    const currentBoxY = y;

    doc.setFillColor(247, 247, 247);
    doc.rect(solKenar, currentBoxY, sayfaGenisligi, requiredBoxHeight, 'F'); 
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.5);
    doc.rect(solKenar, currentBoxY, sayfaGenisligi, requiredBoxHeight, 'S');

    let contentYInsideBox = currentBoxY + boxPadding; 

        if (!alreadyControlledForPage) {
        const titleAndSpacingHeight = PDF_SETTINGS.sectionTitleSize + 5 + PDF_SETTINGS.sourceSectionTitleSpacing;
        y = sayfaKontrolu(doc, y, titleAndSpacingHeight + requiredBoxHeight + 10); 
    }
    
    if (imageDataUrl && calculatedImageHeight > 0) {
        const imgX = solKenar + boxPadding + ( (contentWidthInsideBox - (PDF_SETTINGS.imagePaddingHorizontal * 2) - actualImageWidth) / 2 ) + PDF_SETTINGS.imagePaddingHorizontal;
        
        doc.addImage(imageDataUrl, 'JPEG', imgX, contentYInsideBox, actualImageWidth, calculatedImageHeight);
        contentYInsideBox += calculatedImageHeight + PDF_SETTINGS.imageBottomSpacing;
    }

    if (kullanilanKaynakMetni) {
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.quoteFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);
        
        const alintiMetinBaslangicX = solKenar + boxPadding + PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft;
        const alintiKutuIciGenislik = contentWidthInsideBox - PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft;
        
        doc.setDrawColor(PDF_SETTINGS.sourceLineColor[0], PDF_SETTINGS.sourceLineColor[1], PDF_SETTINGS.sourceLineColor[2]);
        doc.setLineWidth(PDF_SETTINGS.lineThickness);
        
        const metinSatirlari = doc.splitTextToSize(`"${kullanilanKaynakMetni}"`, alintiKutuIciGenislik);
        const alƒ±ntƒ±MetniYuksekligi = metinSatirlari.length * currentFont.size * PDF_SETTINGS.quoteLineHeightMultiplier;
        
        doc.line(solKenar + boxPadding + (PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft / 2), contentYInsideBox, 
                 solKenar + boxPadding + (PDF_SETTINGS.kaynakAlƒ±ntƒ±MarginLeft / 2), contentYInsideBox + alƒ±ntƒ±MetniYuksekligi);
        
        metinSatirlari.forEach(satir => {
            const satirYuksekligi = currentFont.size * PDF_SETTINGS.lineHeightMultiplier; 
            doc.text(satir, alintiMetinBaslangicX, contentYInsideBox);
            contentYInsideBox += satirYuksekligi;
        });
        contentYInsideBox += 15;

        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.footerFontSize, color: PDF_SETTINGS.mediumGray };
        applyCurrentFont(doc);
        doc.text(`Kaynak: ${kaynakKunyesi}`, sagKenar - boxPadding, contentYInsideBox, { align: 'right' });
        contentYInsideBox += 30;
    }
    
    y = currentBoxY + requiredBoxHeight + 10; 
    return y;
}

function addQuestionSection(doc, startY, calismaKagidiMetni, sayfaGenisligi) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;

    y = sayfaKontrolu(doc, y, 50);
    currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.sectionTitleSize, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.text('Analiz ve Yorumlama Sorularƒ±', solKenar, y);

    doc.setDrawColor(PDF_SETTINGS.underlineColor[0], PDF_SETTINGS.underlineColor[1], PDF_SETTINGS.underlineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y + 5, solKenar + PDF_SETTINGS.questionSectionTitleLineLength, y + 5);
    y += 25; 

    const sorular = (calismaKagidiMetni || "").split('\n').filter(s => s.trim().match(/^\d+\./));
    sorular.forEach((satir, index) => {
        const soruMetni = satir.substring(satir.indexOf('.') + 1).trim();
        const soruNumarasi = `${index + 1}.`;

        currentFont = { family: 'Lora', style: 'normal', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.darkGray }; 
        applyCurrentFont(doc); 

        const soruNumarasiGenisligi = doc.getStringUnitWidth(soruNumarasi) * currentFont.size / doc.internal.scaleFactor;
        const metinBaslangicX = solKenar + soruNumarasiGenisligi + 5;
        const metinIcinKullanilabilirGenislik = sayfaGenisligi - soruNumarasiGenisligi - 5;
        
        const tempSoruSatirlari = doc.splitTextToSize(soruMetni, metinIcinKullanilabilirGenislik);
        
        let estimatedQuestionTextHeight = tempSoruSatirlari.length * currentFont.size * PDF_SETTINGS.lineHeightMultiplier; 
        let estimatedQuestionLineHeight = PDF_SETTINGS.soruAltCizgiSayƒ±sƒ± * (currentFont.size * PDF_SETTINGS.lineHeightMultiplier); 
        
        let estimatedQuestionHeight = estimatedQuestionTextHeight + 10 + estimatedQuestionLineHeight + 15;

        y = sayfaKontrolu(doc, y, estimatedQuestionHeight); 

        currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.mediumGray }; 
        applyCurrentFont(doc);
        doc.text(soruNumarasi, solKenar, y);

        currentFont = { family: 'Lora', style: 'normal', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);
        const soruSatirlari = doc.splitTextToSize(soruMetni, metinIcinKullanilabilirGenislik);

        let currentLineY = y;
        soruSatirlari.forEach((soruSatiri) => {
            const satirYuksekligi = currentFont.size * PDF_SETTINGS.lineHeightMultiplier;
            doc.text(soruSatiri, metinBaslangicX, currentLineY);
            currentLineY += satirYuksekligi;
        });
        
        currentLineY += 10; 
        doc.setDrawColor(PDF_SETTINGS.soruCevapCizgiRengi[0], PDF_SETTINGS.soruCevapCizgiRengi[1], PDF_SETTINGS.soruCevapCizgiRengi[2]);
        doc.setLineWidth(0.5);
        for (let i = 0; i < PDF_SETTINGS.soruAltCizgiSayƒ±sƒ±; i++) {
            doc.line(metinBaslangicX, currentLineY, sagKenar, currentLineY);
            currentLineY += currentFont.size * PDF_SETTINGS.lineHeightMultiplier; 
        }
        y = currentLineY + 15;
    });
    return y;
}

function altBilgiEkle(doc) {
    const totalPages = doc.internal.getNumberOfPages();
    const currentYear = new Date().getFullYear();
    const footerBottomMargin = PDF_SETTINGS.altBilgiYOffset;

    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        
        const signatureText = `Bu belge, Akƒ±llƒ± √áalƒ±≈üma Kaƒüƒ±dƒ± Asistanƒ± Amazon Bulut Servisleri tarafƒ±ndan otomatik √ºretilmi≈ütir.`;
        doc.setFont('Lora', 'normal');
        doc.setFontSize(PDF_SETTINGS.footerFontSize - 1);
        doc.setTextColor(100, 100, 100);
        const signatureTextY = doc.internal.pageSize.getHeight() - footerBottomMargin - (PDF_SETTINGS.footerFontSize * PDF_SETTINGS.lineHeightMultiplier) - 5; 
        doc.text(signatureText, doc.internal.pageSize.getWidth() / 2, signatureTextY, { align: 'center' });

        doc.setFont('Lora', 'italic');
        doc.setFontSize(PDF_SETTINGS.footerFontSize);
        doc.setTextColor(150, 150, 150);
        
        const mainFooterText = `Akƒ±llƒ± √áalƒ±≈üma Kaƒüƒ±dƒ± Asistanƒ± ¬© ${currentYear} | Sayfa ${i} / ${totalPages}`;
        const mainFooterTextY = doc.internal.pageSize.getHeight() - footerBottomMargin; 
        doc.text(mainFooterText, doc.internal.pageSize.getWidth() / 2, mainFooterTextY, { align: 'center' });
    }
}
    indirPdfButonu.addEventListener('click', olusturVeIndirPDF);
</script>
</body>
</html>