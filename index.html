<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İnkılap Tarihi Akıllı Çalışma Kağıdı Asistanı</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        h1 { color: #0056b3; text-align: center; }
        select, button { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; box-sizing: border-box; margin-top: 5px; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
        .kaynak-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; border: 1px solid transparent; }
        .kaynak-item:hover { background-color: #f0f0f0; }
        .kaynak-item.selected { border-color: #007bff; background-color: #e7f3ff; }
        .kaynak-item .icon { font-size: 24px; margin-right: 10px; }
        .kaynak-gorsel { max-width: 100%; border-radius: 4px; margin-bottom: 20px; }
        .footer-notice {
            max-width: 800px;
            margin: 40px auto 20px auto; 
            text-align: center;
            font-size: 12px;
            color: #888;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>İnkılap Tarihi Akıllı Çalışma Kağıdı Asistanı</h1>
        <div class="form-group"><label for="unite-secimi">Ünite Seçimi:</label><select id="unite-secimi"><option value="">Lütfen bir ünite seçiniz</option></select></div>
        <div class="form-group"><label for="kazanim-secimi">Kazanım Seçimi:</label><select id="kazanim-secimi" disabled><option value="">Lütfen önce ünite seçiniz</option></select></div>
        
        <div class="form-group">
            <label for="kaynak-listesi">Kaynak Seçimi:</label>
            <div id="kaynak-listesi" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-height: 50px;">
                <p style="color: #6c757d;">Lütfen önce kazanım seçiniz</p>
            </div>
        <div class="footer-notice">
        <p>📜 Bu platformda yer alan belgeler kamuya açık arşivlerden (Atatürk Kitaplığı, SALT Araştırma, Devlet Arşivleri vb.) alınmıştır. Tüm materyaller yalnızca eğitim ve araştırma amaçlı kullanılmakta olup, ilgili kurumların Creative Commons lisans koşullarına tabidir. Bu platform ticari amaç gütmemekte olup, arşiv materyalleri ilgili kurumların mülkiyetindedir.
Herhangi bir hak ihlali tespit edilmesi durumunda ilgili içerik derhal kaldırılacaktır.</p>
        </div>

        <button id="olustur-butonu" disabled>Çalışma Kağıdı Oluştur</button>
        <button id="indir-pdf-butonu" style="display: none; margin-top: 10px; background-color: #28a745;">PDF Olarak İndir</button>

        <div id="kaynak-basligi" style="margin-top: 20px; display: none;"><h3>Kullanılan Birinci Elden Kaynak:</h3></div>
        <div id="kaynak-alani"></div>
        <div id="sonuc-basligi" style="margin-top: 20px; display: none;"><h3>Oluşturulan Çalışma Kağıdı:</h3></div>
        <div id="sonuc-alani"></div>
    </div>

<script>
    const API_ENDPOINT_URL = 'https://duwr3ymxi6.execute-api.eu-central-1.amazonaws.com/';

    let sonApiCevabi = null;

    const uniteSecimi = document.getElementById('unite-secimi');
    const kazanimSecimi = document.getElementById('kazanim-secimi');
    const kaynakListesi = document.getElementById('kaynak-listesi');
    const olusturButonu = document.getElementById('olustur-butonu');
    const kaynakBasligi = document.getElementById('kaynak-basligi');
    const kaynakAlani = document.getElementById('kaynak-alani');
    const sonucBasligi = document.getElementById('sonuc-basligi');
    const sonucAlani = document.getElementById('sonuc-alani');
    const indirPdfButonu = document.getElementById('indir-pdf-butonu');

    const mockUniteler = [
        { id: "1", ad: "1. 20. Yüzyıl Başlarında Osmanlı Devleti ve Dünya" },
        { id: "2", ad: "2. Milli Mücadele" },
        { id: "3", ad: "3. Atatürkçülük ve Türk İnkılabı" },
        { id: "4", ad: "4. İki Savaş Arasındaki Dönemde Türkiye ve Dünya" },
        { id: "5", ad: "5. II.Dünya Savaşı Sürecinde Türkiye ve Dünya" },
        { id: "6", ad: "6. II.Dünya Savaşı Sonrasında Türkiye ve Dünya" },
        { id: "7", ad: "7. Toplumsal Devrim Çağında Dünya ve Türkiye" },
        { id: "8", ad: "8. 21. Yüzyılın Eşiğinde Türkiye ve Dünya" }
    ];

    const mockKazanimlar = {
        "1": [
            { id: "1.1", ad: "1.1. Mustafa Kemal’in Birinci Dünya Savaşı’na kadarki eğitim ve askerlik hayatını içinde bulunduğu toplumun siyasi, sosyal ve kültürel yapısı ile ilişkilendirir" },
            { id: "1.2", ad: "1.2. 20. yüzyıl başlarında Osmanlı Devleti’nin siyasi, sosyal ve ekonomik durumunu analiz eder." },
            { id: "1.3", ad: "1.3. I. Dünya Savaşı sürecinde Osmanlı Devleti’nin durumunu siyasi, askerî ve sosyal açılardan analiz eder." },
            { id: "1.4", ad: "1.4. I. Dünya Savaşı’nın sonuçlarını Osmanlı Devleti ve Batılı devletler açısından değerlendirir." }
        ],
        "2": [
            { id: "2.1", ad: "2.1. Kuvay-ı Millîye hareketinin oluşumundan Büyük Millet Meclisinin açılışına kadar olan süreçte meydana gelen gelişmeleri açıklar." },
            { id: "2.2", ad: "2.2. Büyük Millet Meclisinin açılış sürecini ve sonrasında meydana gelen gelişmeleri kavrar." },
            { id: "2.3", ad: "2.3. Sevr Antlaşması’nın Millî Mücadele sürecine etkilerini analiz eder." },
            { id: "2.4", ad: "2.4. Doğu ve Güney Cephelerinde verilen mücadelelerin ülkemizin bağımsızlık sürecine katkılarını kavrar." },
            { id: "2.5", ad: "2.5. Düzenli ordunun kurulmasından Mudanya Ateşkes Antlaşması’na kadar meydana gelen gelişmeleri Türkiye’nin bağımsızlık sürecine katkıları açısından analiz eder." },
            { id: "2.6", ad: "2.6. Millî Mücadele sonucunda kazanılan diplomatik başarıları ülkemizin bağımsızlığı açısından değerlendirir.2.6. Millî Mücadele sonucunda kazanılan diplomatik başarıları ülkemizin bağımsızlığı açısından değerlendirir." },
            { id: "2.7", ad: "2.7. Millî Mücadele sürecine katkıda bulunmuş önemli şahsiyetlerin kişilik özellikleri ile faaliyetlerini ilişkilendirir." }
        ],
        "3": [
            { id: "3.1", ad: "3.1. Çağdaşlaşan Türkiye’nin temeli olan Atatürk ilkelerini kavrar." },
            { id: "3.2", ad: "3.2. Siyasi alanda meydana gelen gelişmeleri kavrar." },
            { id: "3.3", ad: "3.3. Hukuk alanında meydana gelen gelişmelerin Türk toplumunda meydana getirdiği değişimleri kavrar." },
            { id: "3.4", ad: "3.4. Eğitim ve kültür alanında yapılan inkılapları ve gelişmeleri kavrar." },
            { id: "3.5", ad: "3.5. Toplumsal alanda yapılan inkılapları ve meydana gelen gelişmeleri kavrar." },
            { id: "3.6", ad: "3.6. Ekonomi alanında meydana gelen gelişmeleri kavrar." },
            { id: "3.7", ad: "3.7. Atatürk Dönemi’nde sağlık alanında yapılan çalışmaları kavrar." },
            { id: "3.8", ad: "3.7. Atatürk ilke ve inkılaplarını oluşturan temel esasları Atatürkçü düşünce sistemi açısından analiz eder." },
        ],
        "4": [
            { id: "4.1", ad: "4.1. Atatürk Dönemi’nde Türkiye Cumhuriyeti’nin iç politikasındaki önemli gelişmeleri açıklar." },
            { id: "4.2", ad: "4.2. Atatürk Dönemi’nde (1923-1938) Türkiye Cumhuriyeti’nin dış politikasındaki başlıca gelişmeleri açıklar. " },
            { id: "4.3", ad: "4.3. İki dünya savaşı arasındaki dönemde dünyada meydana gelen siyasi ve ekonomik gelişmeleri kavrar." },
        ],
        "5": [
            { id: "5.1", ad: "5.1. II. Dünya Savaşı’nın sebepleri, başlaması ve yayılmasıyla ilgili başlıca gelişmeleri kavrar" },
            { id: "5.2", ad: "5.2. II. Dünya Savaşı sürecinde Türkiye’nin izlediği siyaset ile savaşın Türkiye üzerindeki ekonomik ve toplumsal etkilerini analiz eder." },
            { id: "5.3", ad: "5.3. II. Dünya Savaşı’nın sonuçlarını değerlendirir." },
        ],
        "6": [
            { id: "6.1", ad: "6.1. 1945-1950 yılları arasında Türkiye’de meydana gelen siyasi, sosyal ve ekonomik gelişmeleri kavrar." },
            { id: "6.2", ad: "6.2. II. Dünya Savaşı sonrası dönemde uluslararası ilişkilerde ve Türk dış politikasında meydana gelen gelişmeleri kavrar." },
            { id: "6.3", ad: "6.3. 1950’ler Türkiye’sinde meydana gelen siyasi, sosyal ve ekonomik gelişmeleri analiz eder." },
        ],
        "7": [
            { id: "7.1", ad: "7.1. 1960 sonrasında dünya siyasetinde ortaya çıkan gelişmeleri açıklar." },
            { id: "7.2", ad: "7.2. 1960’lardan itibaren Türk dış politikasını etkileyen önemli gelişmeleri kavrar." },
            { id: "7.3", ad: "7.3. 1960’lardan itibaren Türkiye’de meydana gelen siyasi, ekonomik ve sosyo-kültürel gelişmeleri analiz eder." },
        ],
        "8": [
            { id: "8.1", ad: "8.1. 1990 sonrasında Türkiye’de meydana gelen ekonomik, siyasi, sosyal ve kültürel gelişmeleri kavrar." },
            { id: "8.2", ad: "8.2. 1990 sonrasında meydana gelen siyasi gelişmeleri Türkiye’ye etkileri ve dünya siyasi konjonktürü bağlamında analiz eder." },
        ]
    };

    function uniteleriYukle() { mockUniteler.forEach(unite => { const option = document.createElement('option'); option.value = unite.id; option.textContent = unite.ad; uniteSecimi.appendChild(option); }); }
    
    function kazanimlariGuncelle(uniteId) {
        kazanimSecimi.innerHTML = '<option value="">Lütfen bir kazanım seçiniz</option>';
        olusturButonu.disabled = true;
        kaynakListesi.innerHTML = '<p style="color: #6c757d;">Lütfen önce kazanım seçiniz</p>';
        if (uniteId) {
            kazanimSecimi.disabled = false;
            const secilenUniteninKazanimlari = mockKazanimlar[uniteId] || [];
            secilenUniteninKazanimlari.forEach(kazanim => {
                const option = document.createElement('option');
                option.value = kazanim.id;
                option.textContent = kazanim.ad;
                kazanimSecimi.appendChild(option);
            });
        } else {
            kazanimSecimi.disabled = true;
        }
    }
    
    async function kaynaklariYukle(unitId, outcomeId) {
        kaynakListesi.innerHTML = '<p class="loading">Kaynaklar yükleniyor...</p>';
        olusturButonu.disabled = true;
        try {
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ unit_id: unitId, outcome_id: outcomeId }),
            });
            if (!response.ok) throw new Error('Kaynaklar sunucudan alınamadı.');
            const kaynaklar = await response.json();
            kaynakListesi.innerHTML = '';
            if (kaynaklar.length > 0) {
                kaynaklar.forEach(kaynak => {
                    const type = (kaynak.source_type || 'belge').toLowerCase();
                    let icon = '📜';
                    if (type === 'gazete') icon = '📰';
                    else if (type === 'hatirat') icon = '📖';
                    else if (type === 'mektup') icon = '✉️';
                    const kaynakItemHTML = `<div class="kaynak-item" data-source-id="${kaynak.source_id}" onclick="kaynakSecildi(this)"><span class="icon" title="${type.charAt(0).toUpperCase() + type.slice(1)}">${icon}</span><span style="font-weight: normal; cursor: pointer;">${kaynak.source_title}</span></div>`;
                    kaynakListesi.innerHTML += kaynakItemHTML;
                });
            } else {
                kaynakListesi.innerHTML = '<p>Bu kazanıma ait kaynak bulunamadı</p>';
            }
        } catch (error) {
            console.error("Kaynakları yüklerken hata oluştu:", error);
            kaynakListesi.innerHTML = '<p style="color: red;">Kaynaklar yüklenemedi.</p>';
        }
    }
    
    function kaynakSecildi(element) {
        document.querySelectorAll('.kaynak-item').forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');
        olusturButonu.disabled = false;
    }

async function calismaKagidiOlustur() {
        const seciliKaynak = document.querySelector('.kaynak-item.selected');
        if (!seciliKaynak) { alert("Lütfen bir kaynak seçiniz."); return; }
        const secilenKaynakId = seciliKaynak.dataset.sourceId;
        const secilenUniteId = uniteSecimi.value;
        
        kaynakAlani.innerHTML = '';
        sonucAlani.innerHTML = '<p class="loading">Çalışma kağıdı hazırlanıyor...</p>';
        kaynakBasligi.style.display = 'none';
        sonucBasligi.style.display = 'none';
        olusturButonu.disabled = true;

        try {
            const istekVerisi = { unit_id: secilenUniteId, source_id: secilenKaynakId };
            const response = await fetch(API_ENDPOINT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(istekVerisi),
            });
            const veri = await response.json();
            if (!response.ok) { throw new Error(veri.message || `Sunucu hatası`); }
                sonApiCevabi = veri; 

            kaynakBasligi.style.display = 'block';
            sonucBasligi.style.display = 'block';
            indirPdfButonu.style.display = 'block';

            const type = (veri.source_type || '').toLowerCase();
            if (type === 'gazete' || type === 'genelge') {
                kaynakAlani.innerHTML = `<img src="${veri.source_url}" alt="${veri.source_title}" class="kaynak-gorsel">
                                         <p style="white-space: pre-wrap; margin-top: 15px; background-color: #f0f0f0; padding: 10px; border-radius: 4px;">${veri.kullanilan_kaynak}</p>`;
            } else {
                kaynakAlani.textContent = veri.kullanilan_kaynak;
            }
            
            const formatlanmisHtml = formatlaCalismaKagidi(veri.calisma_kagidi);
            sonucAlani.innerHTML = formatlanmisHtml;

        } catch (error) {
            console.error('Hata:', error);
            sonucAlani.innerHTML = `<p style="color: red;">${error.message}</p>`;
            kaynakBasligi.style.display = 'none';
            sonucBasligi.style.display = 'none';
            indirPdfButonu.style.display = 'none';
        } finally {
            olusturButonu.disabled = false;
        }
    }
    
    function formatlaCalismaKagidi(metin) { let htmlCiktisi = ''; const satirlar = metin.split('\n'); satirlar.forEach(satir => { satir = satir.trim(); if (satir === '') return; if (satir.startsWith('Soru') || satir.startsWith('Bu metne göre') || satir.startsWith('Cevaplar:')) { htmlCiktisi += `<p><strong>${satir}</strong></p>`; } else if (satir.match(/^[a-d]\)/i)) { htmlCiktisi += `<p style="margin-left: 20px;">${satir}</p>`; } else { htmlCiktisi += `<p>${satir}</p>`; } }); return htmlCiktisi; }

    document.addEventListener('DOMContentLoaded', uniteleriYukle);
    uniteSecimi.addEventListener('change', (event) => {
        kazanimlariGuncelle(event.target.value);
    });
    kazanimSecimi.addEventListener('change', (event) => {
        const secilenUniteId = uniteSecimi.value;
        const secilenKazanimId = event.target.value;
        if (secilenKazanimId) {
            kaynaklariYukle(secilenUniteId, secilenKazanimId);
        } else {
            kaynakListesi.innerHTML = '<p style="color: #6c757d;">Lütfen önce kazanım seçiniz</p>';
            olusturButonu.disabled = true;
        }
    });
    olusturButonu.addEventListener('click', calismaKagidiOlustur);


indirPdfButonu.addEventListener('click', olusturVeIndirPDF);

async function getImageBase64(url) {
    const response = await fetch(url);
    if (!response.ok) { throw new Error(`Resim yüklenemedi: ${response.statusText}`); }
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// ÖNERİ 2: EĞER GEREKİRSE BU KODU KULLAN
const PDF_SETTINGS = {
    marginLeft: 55,
    marginRight: 55,
    marginTop: 60,               // DEĞİŞİKLİK: 70'ten 60'a düşürüldü
    marginBottom: 60,            // DEĞİŞİKLİK: 70'ten 60'a düşürüldü
    headerTopMargin: 60,         // DEĞİŞİKLİK: 70'ten 60'a düşürüldü
    lineHeightMultiplier: 1.2,
    titleColor: [42, 77, 122],
    textColor: [34, 34, 34],
    altTextColor: [120, 120, 120],
    mediumGray: [100, 100, 100],
    darkGray: [50, 50, 50],
    sourceLineColor: [150, 150, 150],
    sectionLineColor: [220, 220, 220],
    underlineColor: [42, 77, 122],
    logoOffset: 15,
    logoSize: 35,
    kazanımLineHeight: 1.2,
    kaynakAlıntıMarginLeft: 15,
    soruNumarasıOffset: 25,
    soruAltCizgiSayısı: 4,
    soruCevapCizgiRengi: [200, 200, 200],
    altBilgiYOffset: 30,
    kazanımFontSize: 12,
    quoteFontSize: 9,
    quoteLineHeightMultiplier: 1.2, // DEĞİŞİKLİK: 1.3'ten 1.2'ye düşürüldü
    footerFontSize: 8,
    sectionTitleSize: 15,
    mainBodyFontSize: 10,
    sourceSectionTitleSpacing: 10,
    imageBottomSpacing: 10,
    minUsableImageHeight: 60,
    imagePaddingHorizontal: 10,
    sourceSectionTitleLineLength: 90,
    questionSectionTitleLineLength: 180,
    lineThickness: 1,
    sourceSectionBottomPadding: 5,
    headerBottomSpacing: 5,
};

// BU KOD BLOĞUNU KOPYALA
let currentFont = { family: 'Lora', style: 'normal', size: 11, color: PDF_SETTINGS.textColor };

function applyCurrentFont(doc) {
    doc.setFont(currentFont.family, currentFont.style);
    doc.setFontSize(currentFont.size);
    doc.setTextColor(currentFont.color[0], currentFont.color[1], currentFont.color[2]);
}

const sayfaKontrolu = (doc, yPozisyonu, gerekliBosluk) => {
    const sayfaAltSiniri = doc.internal.pageSize.getHeight() - PDF_SETTINGS.marginBottom;

    if (yPozisyonu + gerekliBosluk > sayfaAltSiniri) {
        doc.addPage();
        yPozisyonu = PDF_SETTINGS.marginTop;
        applyCurrentFont(doc);
    }
    return yPozisyonu;
};

// LÜTFEN MEVCUT olusturVeIndirPDF FONKSİYONUNU BU YENİ KODLA DEĞİŞTİR
async function olusturVeIndirPDF() {
    if (!sonApiCevabi) {
        alert("PDF oluşturmak için önce bir çalışma kağıdı oluşturmalısınız.");
        return;
    }
    if (indirPdfButonu) {
        indirPdfButonu.disabled = true;
        indirPdfButonu.textContent = "PDF Oluşturuluyor...";
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    try {
        const fetchAssetAsBase64 = async (url) => {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Varlık yüklenemedi: ${url}. HTTP Statü: ${response.status} ${response.statusText}`);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        const [
            loraRegular, loraBold, loraItalic,
            playfairRegular, playfairBold,
            logoBase64
        ] = await Promise.all([
            fetchAssetAsBase64('Lora-Regular.ttf'),
            fetchAssetAsBase64('Lora-Bold.ttf'),
            fetchAssetAsBase64('Lora-Italic.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Regular.ttf'),
            fetchAssetAsBase64('PlayfairDisplay-Bold.ttf'),
            fetchAssetAsBase64('logo.png')
        ]);

        doc.addFileToVFS('Lora-Regular.ttf', loraRegular.split(',')[1]); doc.addFont('Lora-Regular.ttf', 'Lora', 'normal');
        doc.addFileToVFS('Lora-Bold.ttf', loraBold.split(',')[1]); doc.addFont('Lora-Bold.ttf', 'Lora', 'bold');
        doc.addFileToVFS('Lora-Italic.ttf', loraItalic.split(',')[1]); doc.addFont('Lora-Italic.ttf', 'Lora', 'italic');
        doc.addFileToVFS('PlayfairDisplay-Regular.ttf', playfairRegular.split(',')[1]); doc.addFont('PlayfairDisplay-Regular.ttf', 'Playfair', 'normal');
        doc.addFileToVFS('PlayfairDisplay-Bold.ttf', playfairBold.split(',')[1]); doc.addFont('PlayfairDisplay-Bold.ttf', 'Playfair', 'bold');

        // --- DEĞİŞİKLİK BURADA BAŞLIYOR ---

        // 1. Resmi sayfadan al
        let imageDataUrl = null;
        const imageElement = document.querySelector('#kaynak-alani img');
        if (imageElement && imageElement.src) {
            imageDataUrl = await fetchAssetAsBase64(imageElement.src);
        }

        // 2. Metni de sayfadan al (En sağlam yöntem)
        let kaynakMetni = null;
        const metinElementi = document.querySelector('#kaynak-alani p');
        if (metinElementi) {
            kaynakMetni = metinElementi.textContent;
        }

        // --- DEĞİŞİKLİK BURADA BİTİYOR ---

        const kazanımSelect = document.getElementById('kazanim-secimi');
        const seciliKazanimMetni = kazanımSelect && kazanımSelect.options[kazanımSelect.selectedIndex] ? kazanımSelect.options[kazanımSelect.selectedIndex].text.substring(4) : "Belirtilmemiş Kazanım";
        const kaynakKunyesi = sonApiCevabi.source_citation || "Kaynak Belirtilmemiş";

        // Değişen parametrelerle fonksiyonu çağır
        await generatePdfContent(doc, kaynakMetni, sonApiCevabi.calisma_kagidi, imageDataUrl, seciliKazanimMetni, kaynakKunyesi, logoBase64);

        altBilgiEkle(doc);
        doc.save('calisma_kagidi.pdf');

    } catch (error) {
        console.error("PDF oluşturma hatası:", error);
        alert(`PDF oluşturulurken bir hata oluştu: ${error.message}`);
    } finally {
        if (indirPdfButonu) {
            indirPdfButonu.disabled = false;
            indirPdfButonu.textContent = "PDF Olarak İndir";
        }
    }
}

// LÜTFEN MEVCUT generatePdfContent FONKSİYONUNU BU YENİ KODLA DEĞİŞTİR
async function generatePdfContent(doc, kaynakMetni, calismaKagidiMetni, imageDataUrl, kazanımMetni, kaynakKunyesi, logoBase64) {
    let yPozisyonu = PDF_SETTINGS.headerTopMargin;
    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;
    const sayfaGenisligi = sagKenar - solKenar;

    // 1. Header'ı ekle
    yPozisyonu = addHeaderSection(doc, yPozisyonu, logoBase64, kazanımMetni, sayfaGenisligi);

    // 2. Kaynak bölümünü ekle (Artık resim hesaplaması yapmıyor)
    yPozisyonu = await addSourceSection(doc, yPozisyonu, imageDataUrl, kaynakMetni, kaynakKunyesi, sayfaGenisligi);

    // 3. Sorular bölümü için her zaman yeni bir sayfa aç.
    doc.addPage();
    yPozisyonu = PDF_SETTINGS.marginTop;
    applyCurrentFont(doc);

    // 4. Soru bölümünü yeni sayfaya ekle.
    yPozisyonu = addQuestionSection(doc, yPozisyonu, calismaKagidiMetni, sayfaGenisligi);
}

function addHeaderSection(doc, startY, logoBase64, kazanımMetni, sayfaGenisligi) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;
    currentFont = { family: 'Playfair', style: 'bold', size: 24, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.addImage(logoBase64, 'PNG', solKenar, y - PDF_SETTINGS.logoOffset, PDF_SETTINGS.logoSize, PDF_SETTINGS.logoSize);
    doc.text('T.C. İnkılap Tarihi ve Atatürkçülük Dersi', solKenar + PDF_SETTINGS.logoSize + 10, y, { align: 'left' });
    y += 28;

    currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.kazanımFontSize, color: PDF_SETTINGS.mediumGray };
    applyCurrentFont(doc);
    const kazanımSatirlari = doc.splitTextToSize(`Kazanım: ${kazanımMetni}`, sayfaGenisligi);
    doc.text(kazanımSatirlari, solKenar, y, { align: 'left' });
    y += (kazanımSatirlari.length * currentFont.size * PDF_SETTINGS.kazanımLineHeight) + PDF_SETTINGS.headerBottomSpacing; 

    doc.setDrawColor(PDF_SETTINGS.sectionLineColor[0], PDF_SETTINGS.sectionLineColor[1], PDF_SETTINGS.sectionLineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y, doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight, y);
    y += 15;
    return y;
}

// LÜTFEN MEVCUT addSourceSection FONKSİYONUNU BU FİNAL KODUYLA DEĞİŞTİR
async function addSourceSection(doc, startY, imageDataUrl, kullanilanKaynakMetni, kaynakKunyesi, sayfaGenisligi) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;
    const sayfaAltSiniri = doc.internal.pageSize.getHeight() - PDF_SETTINGS.marginBottom;

    // --- Başlık ---
    const titleHeight = PDF_SETTINGS.sectionTitleSize + PDF_SETTINGS.sourceSectionTitleSpacing;
    if (y + titleHeight > sayfaAltSiniri) { doc.addPage(); y = PDF_SETTINGS.marginTop; }
    currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.sectionTitleSize, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.text('Tarihsel Kaynak', solKenar, y);
    doc.setDrawColor(PDF_SETTINGS.underlineColor[0], PDF_SETTINGS.underlineColor[1], PDF_SETTINGS.underlineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y + 5, solKenar + PDF_SETTINGS.sourceSectionTitleLineLength, y + 5);
    y += titleHeight;
    
    // --- Resim ---
    if (imageDataUrl) {
        const contentWidthInsideBox = sayfaGenisligi;
        const maxImageWidthForPage = contentWidthInsideBox * 0.9;
        const maxImageHeightForPage = doc.internal.pageSize.getHeight() * 0.40;
        const imgProps = doc.getImageProperties(imageDataUrl);
        const originalImageRatio = imgProps.width / imgProps.height;
        let tempActualImageWidth = maxImageWidthForPage - (PDF_SETTINGS.imagePaddingHorizontal * 2);
        let tempCalculatedImageHeight = tempActualImageWidth / originalImageRatio;
        if (tempCalculatedImageHeight > maxImageHeightForPage) { tempCalculatedImageHeight = maxImageHeightForPage; tempActualImageWidth = tempCalculatedImageHeight * originalImageRatio; }
        let actualImageWidth = tempActualImageWidth, calculatedImageHeight = tempCalculatedImageHeight;
        if (imgProps.width < tempActualImageWidth && imgProps.height < tempCalculatedImageHeight) { actualImageWidth = imgProps.width; calculatedImageHeight = imgProps.height; }
        if (calculatedImageHeight < PDF_SETTINGS.minUsableImageHeight) { calculatedImageHeight = 0; actualImageWidth = 0; }
        
        if(calculatedImageHeight > 0) {
            if (y + calculatedImageHeight > sayfaAltSiniri) { doc.addPage(); y = PDF_SETTINGS.marginTop; }
            const imgX = solKenar + ((sayfaGenisligi - actualImageWidth) / 2);
            doc.addImage(imageDataUrl, 'JPEG', imgX, y, actualImageWidth, calculatedImageHeight);
            y += calculatedImageHeight + PDF_SETTINGS.imageBottomSpacing;
        }
    }
    
    // --- Metin ve Kaynakça Bloğu (YENİ MANTIK) ---
    if (kullanilanKaynakMetni) {
        const boxPadding = 15;
        
        // Önce tüm metin ve kaynakça satırlarını bir diziye alalım
        const tumSatirlar = [];
        
        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.quoteFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);
        const alintiKutuIciGenislik = sayfaGenisligi - (boxPadding * 2);
        const metinSatirlari = doc.splitTextToSize(`${kullanilanKaynakMetni}`, alintiKutuIciGenislik);
        metinSatirlari.forEach(satir => tumSatirlar.push({ text: satir, type: 'main' }));

        tumSatirlar.push({ text: '', type: 'spacer' });

        currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.footerFontSize, color: PDF_SETTINGS.mediumGray };
        applyCurrentFont(doc);
        const kaynakcaMetni = `Kaynakça: ${kaynakKunyesi || "Kaynak Belirtilmemiş"}`;
        const kaynakcaSatirlari = doc.splitTextToSize(kaynakcaMetni, alintiKutuIciGenislik);
        kaynakcaSatirlari.forEach(satir => tumSatirlar.push({ text: satir, type: 'citation' }));

        // === 1. AŞAMA: HESAPLAMA VE ARKA PLANLARI ÇİZME ===
        let hesaplamaY = y;
        let kutuBaslangicY = hesaplamaY;

        tumSatirlar.forEach(satirData => {
            let satirYuksekligi = 0;
            if (satirData.type === 'main') {
                satirYuksekligi = PDF_SETTINGS.quoteFontSize * PDF_SETTINGS.quoteLineHeightMultiplier;
            } else if (satirData.type === 'citation') {
                satirYuksekligi = PDF_SETTINGS.footerFontSize * PDF_SETTINGS.lineHeightMultiplier;
            } else if (satirData.type === 'spacer') {
                satirYuksekligi = 10;
            }

            if (hesaplamaY + satirYuksekligi + boxPadding > sayfaAltSiniri) {
                // ÖNCEKİ SAYFANIN KUTUSUNU TAMAMLA
                const mevcutKutuYuksekligi = (hesaplamaY - kutuBaslangicY) + boxPadding;
                doc.setFillColor(247, 247, 247);
                doc.rect(solKenar, kutuBaslangicY, sayfaGenisligi, mevcutKutuYuksekligi, 'F');
                doc.setDrawColor(PDF_SETTINGS.sourceLineColor[0], PDF_SETTINGS.sourceLineColor[1], PDF_SETTINGS.sourceLineColor[2]);
                doc.line(solKenar + (boxPadding / 2), kutuBaslangicY, solKenar + (boxPadding / 2), kutuBaslangicY + mevcutKutuYuksekligi);
                
                // YENİ SAYFAYI BAŞLAT
                doc.addPage();
                hesaplamaY = PDF_SETTINGS.marginTop;
                kutuBaslangicY = hesaplamaY;
            }
            hesaplamaY += satirYuksekligi;
        });

        // SON SAYFANIN KUTUSUNU TAMAMLA
        const sonKutuYuksekligi = (hesaplamaY - kutuBaslangicY) + boxPadding;
        doc.setFillColor(247, 247, 247);
        doc.rect(solKenar, kutuBaslangicY, sayfaGenisligi, sonKutuYuksekligi, 'F');
        doc.setDrawColor(PDF_SETTINGS.sourceLineColor[0], PDF_SETTINGS.sourceLineColor[1], PDF_SETTINGS.sourceLineColor[2]);
        doc.line(solKenar + (boxPadding / 2), kutuBaslangicY, solKenar + (boxPadding / 2), kutuBaslangicY + sonKutuYuksekligi);


        // === 2. AŞAMA: METNİ ARKA PLANIN ÜZERİNE YAZDIRMA ===
        let metinY = y;
        let metinKutuBaslangicY = metinY; // Bu gereksiz olabilir ama mantık tutarlılığı için

        tumSatirlar.forEach(satirData => {
            let satirYuksekligi = 0;
             if (satirData.type === 'main') {
                satirYuksekligi = PDF_SETTINGS.quoteFontSize * PDF_SETTINGS.quoteLineHeightMultiplier;
            } else if (satirData.type === 'citation') {
                satirYuksekligi = PDF_SETTINGS.footerFontSize * PDF_SETTINGS.lineHeightMultiplier;
            } else if (satirData.type === 'spacer') {
                satirYuksekligi = 10;
            }
            
            // Sayfa sonu kontrolü. Sadece Y pozisyonunu resetle, çizim yapma.
            if (metinY + satirYuksekligi + boxPadding > sayfaAltSiniri) {
                doc.addPage();
                metinY = PDF_SETTINGS.marginTop;
            }

            // Metni yazdır
            if (satirData.type === 'main') {
                currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.quoteFontSize, color: PDF_SETTINGS.darkGray };
                applyCurrentFont(doc);
                doc.text(satirData.text, solKenar + boxPadding, metinY + boxPadding);
            } else if (satirData.type === 'citation') {
                currentFont = { family: 'Lora', style: 'italic', size: PDF_SETTINGS.footerFontSize, color: PDF_SETTINGS.mediumGray };
                applyCurrentFont(doc);
                // Sağdan hizalamak için metnin başlangıç Y pozisyonu aynı olmalı
                doc.text(satirData.text, sagKenar - boxPadding, metinY + boxPadding, { align: 'right' });
            }
            
            metinY += satirYuksekligi;
        });

        y = metinY + boxPadding * 2; // Kutu alt boşluğunu da ekleyerek Y'yi güncelle
    }

    return y;
}

function addQuestionSection(doc, startY, calismaKagidiMetni, sayfaGenisligi) {
    let y = startY;
    const solKenar = PDF_SETTINGS.marginLeft;
    const sagKenar = doc.internal.pageSize.getWidth() - PDF_SETTINGS.marginRight;

    currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.sectionTitleSize, color: PDF_SETTINGS.titleColor };
    applyCurrentFont(doc);
    doc.text('Analiz ve Yorumlama Soruları', solKenar, y);

    doc.setDrawColor(PDF_SETTINGS.underlineColor[0], PDF_SETTINGS.underlineColor[1], PDF_SETTINGS.underlineColor[2]);
    doc.setLineWidth(PDF_SETTINGS.lineThickness);
    doc.line(solKenar, y + 5, solKenar + PDF_SETTINGS.questionSectionTitleLineLength, y + 5);
    y += 25;

    const sorular = (calismaKagidiMetni || "").split('\n').filter(s => s.trim() !== '');

    sorular.forEach((soruMetni, index) => { 
        const soruNumarasi = `${index + 1}.`;

        currentFont = { family: 'Lora', style: 'normal', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);

        const soruNumarasiGenisligi = doc.getStringUnitWidth(soruNumarasi) * currentFont.size / doc.internal.scaleFactor;
        const metinBaslangicX = solKenar + soruNumarasiGenisligi + 5;
        const metinIcinKullanilabilirGenislik = sayfaGenisligi - soruNumarasiGenisligi - 5;

        const tempSoruSatirlari = doc.splitTextToSize(soruMetni, metinIcinKullanilabilirGenislik);

        let estimatedQuestionTextHeight = tempSoruSatirlari.length * currentFont.size * PDF_SETTINGS.lineHeightMultiplier;
        let estimatedQuestionLineHeight = PDF_SETTINGS.soruAltCizgiSayısı * (currentFont.size * PDF_SETTINGS.lineHeightMultiplier);
        let estimatedQuestionHeight = estimatedQuestionTextHeight + 10 + estimatedQuestionLineHeight + 15;

        y = sayfaKontrolu(doc, y, estimatedQuestionHeight);

        currentFont = { family: 'Playfair', style: 'bold', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.mediumGray };
        applyCurrentFont(doc);
        doc.text(soruNumarasi, solKenar, y);

        currentFont = { family: 'Lora', style: 'normal', size: PDF_SETTINGS.mainBodyFontSize, color: PDF_SETTINGS.darkGray };
        applyCurrentFont(doc);
        const soruSatirlari = doc.splitTextToSize(soruMetni, metinIcinKullanilabilirGenislik);

        let currentLineY = y;
        soruSatirlari.forEach((soruSatiri) => {
            const satirYuksekligi = currentFont.size * PDF_SETTINGS.lineHeightMultiplier;
            doc.text(soruSatiri, metinBaslangicX, currentLineY);
            currentLineY += satirYuksekligi;
        });

        currentLineY += 10;
        doc.setDrawColor(PDF_SETTINGS.soruCevapCizgiRengi[0], PDF_SETTINGS.soruCevapCizgiRengi[1], PDF_SETTINGS.soruCevapCizgiRengi[2]);
        doc.setLineWidth(0.5);
        for (let i = 0; i < PDF_SETTINGS.soruAltCizgiSayısı; i++) {
            doc.line(metinBaslangicX, currentLineY, sagKenar, currentLineY);
            currentLineY += currentFont.size * PDF_SETTINGS.lineHeightMultiplier;
        }
        y = currentLineY + 15;
    });
    return y;
}

function altBilgiEkle(doc) {
    const totalPages = doc.internal.getNumberOfPages();
    const currentYear = new Date().getFullYear();
    const footerBottomMargin = PDF_SETTINGS.altBilgiYOffset;

    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);

        const signatureText = `Bu belge, Akıllı Çalışma Kağıdı Asistanı Amazon Bulut Servisleri tarafından otomatik üretilmiştir.`;
        doc.setFont('Lora', 'normal');
        doc.setFontSize(PDF_SETTINGS.footerFontSize - 1);
        doc.setTextColor(100, 100, 100);
        const signatureTextY = doc.internal.pageSize.getHeight() - footerBottomMargin - (PDF_SETTINGS.footerFontSize * PDF_SETTINGS.lineHeightMultiplier) - 5;
        doc.text(signatureText, doc.internal.pageSize.getWidth() / 2, signatureTextY, { align: 'center' });

        doc.setFont('Lora', 'italic');
        doc.setFontSize(PDF_SETTINGS.footerFontSize);
        doc.setTextColor(150, 150, 150);

        const mainFooterText = `Akıllı Çalışma Kağıdı Asistanı © Oğuzhan Başsarı ${currentYear} | Sayfa ${i} / ${totalPages}`;
        const mainFooterTextY = doc.internal.pageSize.getHeight() - footerBottomMargin;
        doc.text(mainFooterText, doc.internal.pageSize.getWidth() / 2, mainFooterTextY, { align: 'center' });
    }
}
    indirPdfButonu.addEventListener('click', olusturVeIndirPDF);
</script>
</body>
</html>