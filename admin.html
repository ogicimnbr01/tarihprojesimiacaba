<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarih Projesi - Admin Paneli</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        h1 { color: #1c1e21; text-align: center; margin-bottom: 20px; font-size: 24px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #606770; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dddfe2; box-sizing: border-box; font-size: 16px; }
        textarea { min-height: 150px; resize: vertical; }
        button { width: 100%; padding: 12px; border-radius: 6px; border: none; background-color: #1877f2; color: white; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #a0bdf1; cursor: not-allowed; }
        .status { margin-top: 15px; text-align: center; font-weight: 600; }
        .success { color: #31a24c; }
        .error { color: #fa383e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Yeni Tarihsel Kaynak Yükle</h1>
        <form id="upload-form">
            <div class="form-group">
                <label for="unite-secimi">Ünite Seçimi:</label>
                <select id="unite-secimi" required></select>
            </div>
            <div class="form-group">
                <label for="kazanim-secimi">Kazanım Seçimi:</label>
                <select id="kazanim-secimi" required></select>
            </div>
            <div class="form-group">
                <label for="source-type">Kaynak Türü:</label>
                <select id="source-type" required>
                    <option value="gazete">Gazete</option>
                    <option value="mektup">Mektup</option>
                    <option value="hatirat">Hatırat</option>
                    <option value="genelge">Genelge</option>
                    <option value="belge">Diğer Belge</option>
                </select>
            </div>
            <div class="form-group">
                <label for="source-title">Kaynak Başlığı:</label>
                <input type="text" id="source-title" placeholder="Örn: Hakimiyeti Milliye 10 Ocak 1920" required>
            </div>
            <div class="form-group">
                <label for="file-input">Belge Dosyası (PDF, JPG, PNG):</label>
                <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            <div class="form-group">
                <label for="extracted-text">Belge Metni (OCR ile okunamazsa burayı doldurun):</label>
                <textarea id="extracted-text" placeholder="Bu alan boş bırakılırsa, PDF dosyaları için OCR otomatik çalışır. Resim dosyaları için bu alanı doldurmak zorunludur."></textarea>
            </div>
            <button type="submit" id="submit-button">Kütüphaneye Ekle</button>
            <div id="status-message" class="status"></div>
        </form>
    </div>

<script>
    const ADMIN_API_ENDPOINT = 'https://duwr3ymxi6.execute-api.eu-central-1.amazonaws.com/admin'; // API Gateway URL'in sonuna /admin ekle
    const CLOUDFRONT_DOMAIN = 'd1harkx0z87fcn.cloudfront.net'; // CloudFront Dağıtım Alan Adın

        const mockUniteler = [
        { id: "1", ad: "1. 20. Yüzyıl Başlarında Osmanlı Devleti ve Dünya" },
        { id: "2", ad: "2. Milli Mücadele" },
        { id: "3", ad: "3. Atatürkçülük ve Türk İnkılabı" },
        { id: "4", ad: "4. İki Savaş Arasındaki Dönemde Türkiye ve Dünya" },
        { id: "5", ad: "5. II.Dünya Savaşı Sürecinde Türkiye ve Dünya" },
        { id: "6", ad: "6. II.Dünya Savaşı Sonrasında Türkiye ve Dünya" },
        { id: "7", ad: "7. Toplumsal Devrim Çağında Dünya ve Türkiye" },
        { id: "8", ad: "8. 21. Yüzyılın Eşiğinde Türkiye ve Dünya" }
    ];

    const mockKazanimlar = {
        "1": [
            { id: "1.1", ad: "1.1. Mustafa Kemal’in Birinci Dünya Savaşı’na kadarki eğitim ve askerlik hayatını içinde bulunduğu toplumun siyasi, sosyal ve kültürel yapısı ile ilişkilendirir" },
            { id: "1.2", ad: "1.2. 20. yüzyıl başlarında Osmanlı Devleti’nin siyasi, sosyal ve ekonomik durumunu analiz eder." },
            { id: "1.3", ad: "1.3. I. Dünya Savaşı sürecinde Osmanlı Devleti’nin durumunu siyasi, askerî ve sosyal açılardan analiz eder." },
            { id: "1.4", ad: "1.4. I. Dünya Savaşı’nın sonuçlarını Osmanlı Devleti ve Batılı devletler açısından değerlendirir." }
        ],
        "2": [
            { id: "2.1", ad: "2.1. Kuvay-ı Millîye hareketinin oluşumundan Büyük Millet Meclisinin açılışına kadar olan süreçte meydana gelen gelişmeleri açıklar." },
            { id: "2.2", ad: "2.2. Büyük Millet Meclisinin açılış sürecini ve sonrasında meydana gelen gelişmeleri kavrar." },
            { id: "2.3", ad: "2.3. Sevr Antlaşması’nın Millî Mücadele sürecine etkilerini analiz eder." },
            { id: "2.4", ad: "2.4. Doğu ve Güney Cephelerinde verilen mücadelelerin ülkemizin bağımsızlık sürecine katkılarını kavrar." },
            { id: "2.5", ad: "2.5. Düzenli ordunun kurulmasından Mudanya Ateşkes Antlaşması’na kadar meydana gelen gelişmeleri Türkiye’nin bağımsızlık sürecine katkıları açısından analiz eder." },
            { id: "2.6", ad: "2.6. Millî Mücadele sonucunda kazanılan diplomatik başarıları ülkemizin bağımsızlığı açısından değerlendirir.2.6. Millî Mücadele sonucunda kazanılan diplomatik başarıları ülkemizin bağımsızlığı açısından değerlendirir." },
            { id: "2.7", ad: "2.7. Millî Mücadele sürecine katkıda bulunmuş önemli şahsiyetlerin kişilik özellikleri ile faaliyetlerini ilişkilendirir." }
        ],
        "3": [
            { id: "3.1", ad: "3.1. Çağdaşlaşan Türkiye’nin temeli olan Atatürk ilkelerini kavrar." },
            { id: "3.2", ad: "3.2. Siyasi alanda meydana gelen gelişmeleri kavrar." },
            { id: "3.3", ad: "3.3. Hukuk alanında meydana gelen gelişmelerin Türk toplumunda meydana getirdiği değişimleri kavrar." },
            { id: "3.4", ad: "3.4. Eğitim ve kültür alanında yapılan inkılapları ve gelişmeleri kavrar." },
            { id: "3.5", ad: "3.5. Toplumsal alanda yapılan inkılapları ve meydana gelen gelişmeleri kavrar." },
            { id: "3.6", ad: "3.6. Ekonomi alanında meydana gelen gelişmeleri kavrar." },
            { id: "3.7", ad: "3.7. Atatürk Dönemi’nde sağlık alanında yapılan çalışmaları kavrar." },
            { id: "3.8", ad: "3.7. Atatürk ilke ve inkılaplarını oluşturan temel esasları Atatürkçü düşünce sistemi açısından analiz eder." },
        ],
        "4": [
            { id: "4.1", ad: "4.1. Atatürk Dönemi’nde Türkiye Cumhuriyeti’nin iç politikasındaki önemli gelişmeleri açıklar." },
            { id: "4.2", ad: "4.2. Atatürk Dönemi’nde (1923-1938) Türkiye Cumhuriyeti’nin dış politikasındaki başlıca gelişmeleri açıklar. " },
            { id: "4.3", ad: "4.3. İki dünya savaşı arasındaki dönemde dünyada meydana gelen siyasi ve ekonomik gelişmeleri kavrar." },
        ],
        "5": [
            { id: "5.1", ad: "5.1. II. Dünya Savaşı’nın sebepleri, başlaması ve yayılmasıyla ilgili başlıca gelişmeleri kavrar" },
            { id: "5.2", ad: "5.2. II. Dünya Savaşı sürecinde Türkiye’nin izlediği siyaset ile savaşın Türkiye üzerindeki ekonomik ve toplumsal etkilerini analiz eder." },
            { id: "5.3", ad: "5.3. II. Dünya Savaşı’nın sonuçlarını değerlendirir." },
        ],
        "6": [
            { id: "6.1", ad: "6.1. 1945-1950 yılları arasında Türkiye’de meydana gelen siyasi, sosyal ve ekonomik gelişmeleri kavrar." },
            { id: "6.2", ad: "6.2. II. Dünya Savaşı sonrası dönemde uluslararası ilişkilerde ve Türk dış politikasında meydana gelen gelişmeleri kavrar." },
            { id: "6.3", ad: "6.3. 1950’ler Türkiye’sinde meydana gelen siyasi, sosyal ve ekonomik gelişmeleri analiz eder." },
        ],
        "7": [
            { id: "7.1", ad: "7.1. 1960 sonrasında dünya siyasetinde ortaya çıkan gelişmeleri açıklar." },
            { id: "7.2", ad: "7.2. 1960’lardan itibaren Türk dış politikasını etkileyen önemli gelişmeleri kavrar." },
            { id: "7.3", ad: "7.3. 1960’lardan itibaren Türkiye’de meydana gelen siyasi, ekonomik ve sosyo-kültürel gelişmeleri analiz eder." },
        ],
        "8": [
            { id: "8.1", ad: "8.1. 1990 sonrasında Türkiye’de meydana gelen ekonomik, siyasi, sosyal ve kültürel gelişmeleri kavrar." },
            { id: "8.2", ad: "8.2. 1990 sonrasında meydana gelen siyasi gelişmeleri Türkiye’ye etkileri ve dünya siyasi konjonktürü bağlamında analiz eder." },
        ]
    };
    
    const uniteSecimi = document.getElementById('unite-secimi');
    const kazanimSecimi = document.getElementById('kazanim-secimi');
    
    uniteSecimi.innerHTML = '<option value="">Lütfen bir ünite seçiniz</option>' + mockUniteler.map(u => `<option value="${u.id}">${u.ad}</option>`).join('');
    
    uniteSecimi.addEventListener('change', () => {
        const uniteId = uniteSecimi.value;
        kazanimSecimi.innerHTML = '<option value="">Lütfen bir kazanım seçiniz</option>';
        if (uniteId && mockKazanimlar[uniteId]) {
            kazanimSecimi.innerHTML += mockKazanimlar[uniteId].map(k => `<option value="${k.id}">${k.ad}</option>`).join('');
        }
    });

    const form = document.getElementById('upload-form');
    const submitButton = document.getElementById('submit-button');
    const statusMessage = document.getElementById('status-message');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.textContent = "Yükleniyor...";
        statusMessage.textContent = '';
        statusMessage.className = 'status';

        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        try {
            statusMessage.textContent = 'Yükleme adresi alınıyor...';
            const extension = file.name.split('.').pop();
            const getUrlResponse = await fetch(ADMIN_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: 'get_upload_url',
                    extension: extension,
                    contentType: file.type
                })
            });
            const { upload_url, object_key } = await getUrlResponse.json();
            if (!upload_url) throw new Error('Yükleme URL\'i alınamadı.');

            statusMessage.textContent = 'Dosya S3\'e yükleniyor...';
            await fetch(upload_url, {
                method: 'PUT',
                body: file,
                headers: { 'Content-Type': file.type }
            });

            statusMessage.textContent = 'Veriler veritabanına kaydediliyor...';
            const source_url = `https://${CLOUDFRONT_DOMAIN}/${object_key}`;
            
            const metadata = {
                unit_id: uniteSecimi.value,
                outcome_id: kazanimSecimi.value,
                source_type: document.getElementById('source-type').value,
                source_title: document.getElementById('source-title').value,
                extracted_text: document.getElementById('extracted-text').value,
                source_url: source_url
            };

            const saveMetadataResponse = await fetch(ADMIN_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: 'save_metadata',
                    metadata: metadata
                })
            });

            const result = await saveMetadataResponse.json();
            if (saveMetadataResponse.status !== 200) throw new Error(result.error || 'Metadata kaydedilemedi.');

            statusMessage.textContent = 'Başarılı! Belge kütüphaneye eklendi.';
            statusMessage.classList.add('success');
            form.reset();

        } catch (error) {
            console.error('Yükleme hatası:', error);
            statusMessage.textContent = `Hata: ${error.message}`;
            statusMessage.classList.add('error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Kütüphaneye Ekle";
        }
    });
</script>
</body>
</html>